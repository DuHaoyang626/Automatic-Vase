C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Program Files\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include"reg52.h"
   2          #include "intrins.h"
   3          
   4          
   5          //????
   6          typedef unsigned int u16;
   7          typedef unsigned char u8;
   8          
   9          
  10          //????
  11          
  12          #define LCD1602_DATAPORT P0//LCD????P0^0-P0^3
  13          sbit cs = P0^4;//????,?????
  14          sbit clk = P0^5;//??????
  15          sbit dio = P0^6;//????DI???DO
  16          sbit WIFI_IO=P0^7;//??WiFi???P0^7
  17          
  18          #define KEY_MATRIX_PORT P1//???????
  19          
  20          sbit PUMP=P2^0;//????P2^0
  21          sbit SPRAY=P2^1;//?????2^1
  22          sbit LIGHT=P2^2;//LED?????P2^2
  23          sbit MOISTURE_AIR=P2^3;//?????????P2^3
  24          sbit TEMPATURE=P2^4;//???????P2^4
  25          sbit LCD1602_RW=P2^5;//LCD????
  26          sbit LCD1602_RS=P2^6;//LCD??????
  27          sbit LCD1602_E=P2^7; //LCD????
  28          
  29          sbit STEPMOTOR1=P3^0;//????1??P3^0
  30          sbit STEPMOTOR2=P3^1;//????2??P3^1
  31          sbit STEPMOTOR3=P3^2;//????3??P3^2
  32          sbit STEPMOTOR4=P3^3;//????4??P3^3
  33          sbit DIN  = P3^4;   //??ADC??
  34          sbit CS   = P3^5;   //??ADC??
  35          sbit CLK  = P3^6;   //??ADC??
  36          sbit DOUT = P3^7;   //??ADC??
  37          
  38          //????
  39          
  40          //LCD1602???4??8???,??1,??LCD1602???????,???8?
  41          #define LCD1602_4OR8_DATA_INTERFACE 1 //????4????LCD1602
  42          
  43          // ????????,???,????
  44          #define STEPMOTOR_MAXSPEED        1//????????,????1
  45          #define STEPMOTOR_MINSPEED        5//????????
  46          #define STEPMOTOR_SHIELD_HIGHT    10//?????
  47          #define STEPMOTOR_SHIELD_RANGE    750//?????????
  48          
  49          //????
  50          //????????
  51          u16 stay_time;
  52          
  53          //???????
  54          u16 temp_value;
  55          u8 temp_buf[8];
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 2   

  56          
  57          //?????????
  58          u16 soil_moisture;
  59          u8 soil_moisture_buf[4];
  60          
  61          //???????
  62          u16 water_lavel;
  63          u8 water_lavel_buf[4];
  64          
  65          //?????????
  66          u8 temp=0;
  67          u8 humi=0;
  68          u8 i=0;
  69          u8 temp_buf2[3],humi_buf[3];
  70          
  71          //???????
  72          u16 light_intensity=0;
  73          u8 light_intensity_buf[4];
  74                  
  75          //???????????,0?????,1?????
  76          u16 StepMotor_status=0;
  77          
  78          //??????
  79          u8 key=0;
  80          
  81          //test2????
  82          u16 allow_test2=0;
  83          //????
  84          
  85          //??2us
  86          void Delay_2us(void)
  87          {
  88   1        _nop_();
  89   1        _nop_();
  90   1      }
  91          
  92          //????,??int x,??x/100??
  93          void delay_10us(u16 ten_us){
  94   1      while(ten_us--);
  95   1      }
  96          
  97          //????,??int x,??x??
  98          void delay_ms(u16 ms)
  99          {
 100   1        u16 i,j;
 101   1        for(i=ms;i>0;i--)
 102   1          for(j=110;j>0;j--);
 103   1      }
 104          
 105          //????????
 106          
 107          //??ADC2046??
 108          /*******************************************************************************
 109          * ? ? ?       : xpt2046_wirte_data
 110          * ????     : XPT2046???
 111          * ?    ?       : dat:?????
 112          * ?    ?       : ?
 113          *******************************************************************************/
 114          void xpt2046_wirte_data(u8 dat)
 115          {
 116   1        u8 i;
 117   1      
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 3   

 118   1        CLK = 0;
 119   1        _nop_();
 120   1        for(i=0;i<8;i++)//??8?,??????,?????
 121   1        {
 122   2          DIN = dat >> 7;//????????
 123   2          dat <<= 1;//???????
 124   2          CLK = 0;//CLK???????????,??????
 125   2          _nop_();  
 126   2          CLK = 1;
 127   2          _nop_();
 128   2        }
 129   1      }
 130          
 131          /*******************************************************************************
 132          * ? ? ?       : xpt2046_read_data
 133          * ????     : XPT2046???
 134          * ?    ?       : ?
 135          * ?    ?       : XPT2046??12???
 136          *******************************************************************************/
 137          u16 xpt2046_read_data(void)
 138          {
 139   1        u8 i;
 140   1        u16 dat=0;
 141   1      
 142   1        CLK = 0;
 143   1        _nop_();
 144   1        for(i=0;i<12;i++)//??12?,??????,???????,????????u16
 145   1        {
 146   2          dat <<= 1;
 147   2          CLK = 1;
 148   2          _nop_();
 149   2          CLK = 0; //CLK???????????,??????
 150   2          _nop_();
 151   2          dat |= DOUT;//?????,??????  
 152   2        }
 153   1        return dat; 
 154   1      }
 155          
 156          /*******************************************************************************
 157          * ? ? ?       : xpt2046_read_adc_value
 158          * ????     : XPT2046?AD??
 159          * ?    ?       : cmd:??
 160          * ?    ?       : XPT2046??AD?
 161          *******************************************************************************///////////////////////////
             -///////////////////////
 162          u16 xpt2046_read_adc_value(u8 cmd)
 163          {
 164   1        u8 i;
 165   1        u16 adc_value=0;
 166   1      
 167   1        CLK = 0;//?????
 168   1        CS  = 0;//??XPT2046
 169   1        xpt2046_wirte_data(cmd);//?????
 170   1        for(i=6; i>0; i--);//????????
 171   1        CLK = 1;
 172   1        _nop_();
 173   1        CLK = 0;//??????,??BUSY
 174   1        _nop_();
 175   1        adc_value=xpt2046_read_data();
 176   1        CS = 1;//??XPT2046
 177   1        return adc_value;
 178   1      }
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 4   

 179          
 180          //??ADC0832
 181          /*****************************************
 182          ????:??ADC0832??
 183          ????:ADC_read_data(bit channel)
 184          ????:ch?????,ch=0????0,ch=1????1
 185          ????:?????????ADC??,???unsigned char
 186                ?????0?,??????
 187          ******************************************/
 188          u8 ADC_read_data(bit channel)
 189          {
 190   1        u8 i,dat0=0,dat1=0;
 191   1        //------?1??????di??,????---------
 192   1      
 193   1        cs=0;     //??????,??AD????
 194   1        clk=0;      //?????
 195   1        
 196   1        dio=1;      //????????
 197   1        Delay_2us();
 198   1        clk=1;      //???????,??????,??????(DI=1)
 199   1        Delay_2us();
 200   1          clk=0;      //?1??????
 201   1        dio=1;
 202   1        Delay_2us();
 203   1        
 204   1        clk=1;        // ?2??????DI=1,??????????
 205   1        Delay_2us();   
 206   1        //------??2????,??????????(1:????,0:??????)---------    
 207   1        clk=0;  
 208   1        dio=channel;         // ?3????,??DI,????;
 209   1        Delay_2us();
 210   1        clk=1;
 211   1        Delay_2us();
 212   1      
 213   1         //------??3????,??????????(1:??CH1,0:??CH0)------------  
 214   1        
 215   1        clk=0;
 216   1        dio=1;          //????????,DI??,????? 
 217   1        Delay_2us();  
 218   1        for(i=0;i<8;i++)                 //?4~11?8???????(MSB->LSB)
 219   1        {
 220   2          clk=1;
 221   2          Delay_2us();
 222   2          clk=0;
 223   2          Delay_2us();
 224   2          dat0=dat0<<1|dio;
 225   2        }
 226   1        for(i=0;i<8;i++)                 //?11~18?8???????(LSB->MSB)
 227   1        {
 228   2          dat1=dat1|((u8)(dio)<<i);
 229   2          clk=1;
 230   2          Delay_2us();
 231   2          clk=0;
 232   2          Delay_2us();
 233   2        } 
 234   1        cs=1;         
 235   1        return (dat0==dat1)?dat0:0;     //??dat0?dat1????
 236   1      }
 237          
 238          //LCD????
 239          /*******************************************************************************
 240          * ? ? ?       : lcd1602_write_cmd
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 5   

 241          * ????     : LCD1602???
 242          * ?    ?       : cmd:??
 243          * ?    ?       : ?
 244          *******************************************************************************/
 245          #if (LCD1602_4OR8_DATA_INTERFACE==0)//8?LCD
              void lcd1602_write_cmd(u8 cmd)
              {
                LCD1602_RS=0;//????
                LCD1602_RW=0;//???
                LCD1602_E=0;
                LCD1602_DATAPORT=cmd;//????
                delay_ms(1);
                LCD1602_E=1;//???E??????
                delay_ms(1);
                LCD1602_E=0;//???E????????  
              }
              #else //4?LCD
 258          void lcd1602_write_cmd(u8 cmd)
 259          {
 260   1        LCD1602_RS=0;//????
 261   1        LCD1602_RW=0;//???
 262   1        LCD1602_E=0;
 263   1        LCD1602_DATAPORT=cmd;//????
 264   1        delay_ms(1);
 265   1        LCD1602_E=1;//???E??????
 266   1        delay_ms(1);
 267   1        LCD1602_E=0;//???E????????
 268   1        
 269   1        LCD1602_DATAPORT=cmd<<4;//????
 270   1        delay_ms(1);
 271   1        LCD1602_E=1;//???E??????
 272   1        delay_ms(1);
 273   1        LCD1602_E=0;//???E????????  
 274   1      }
 275          #endif
 276          
 277          /*******************************************************************************
 278          * ? ? ?       : lcd1602_write_data
 279          * ????     : LCD1602???
 280          * ?    ?       : dat:??
 281          * ?    ?       : ?
 282          *******************************************************************************/
 283          #if (LCD1602_4OR8_DATA_INTERFACE==0)//8?LCD
              void lcd1602_write_data(u8 dat) 
              {
                LCD1602_RS=1;//????
                LCD1602_RW=0;//???
                LCD1602_E=0;
                LCD1602_DATAPORT=dat;//????
                delay_ms(1);
                LCD1602_E=1;//???E??????
                delay_ms(1);
                LCD1602_E=0;//???E????????    
              }
              #else
 296          void lcd1602_write_data(u8 dat) 
 297          {
 298   1        LCD1602_RS=1;//????
 299   1        LCD1602_RW=0;//???
 300   1        LCD1602_E=0;
 301   1        LCD1602_DATAPORT=dat;//????
 302   1        delay_ms(1);
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 6   

 303   1        LCD1602_E=1;//???E??????
 304   1        delay_ms(1);
 305   1        LCD1602_E=0;//???E????????
 306   1        
 307   1        LCD1602_DATAPORT=dat<<4;//????
 308   1        delay_ms(1);
 309   1        LCD1602_E=1;//???E??????
 310   1        delay_ms(1);
 311   1        LCD1602_E=0;//???E????????    
 312   1      }
 313          #endif
 314          
 315          /*******************************************************************************
 316          * ? ? ?       : lcd1602_init
 317          * ????     : LCD1602???
 318          * ?    ?       : ?
 319          * ?    ?       : ?
 320          *******************************************************************************///////////////////////////
             -///////////////////////
 321          #if (LCD1602_4OR8_DATA_INTERFACE==0)//8?LCD
              void lcd1602_init(void)
              {
                lcd1602_write_cmd(0x38);//????8?,??2?,5*7??/??
                lcd1602_write_cmd(0x0c);//?????,???,????
                lcd1602_write_cmd(0x06);//??????????,??????
                lcd1602_write_cmd(0x01);//??  
              }
              #else
 330          void lcd1602_init(void)
 331          {
 332   1        lcd1602_write_cmd(0x28);//????4?,??2?,5*7??/??
 333   1        lcd1602_write_cmd(0x0c);//?????,???,????
 334   1        lcd1602_write_cmd(0x06);//??????????,??????
 335   1        lcd1602_write_cmd(0x01);//??  
 336   1      }
 337          #endif
 338          
 339          /*******************************************************************************
 340          * ? ? ?       : lcd1602_clear
 341          * ????     : LCD1602??
 342          * ?    ?       : ?
 343          * ?    ?       : ?
 344          *******************************************************************************/
 345          void lcd1602_clear(void)
 346          {
 347   1        lcd1602_write_cmd(0x01);  
 348   1      }
 349          
 350          /*******************************************************************************
 351          * ? ? ?       : lcd1602_show_string
 352          * ????     : LCD1602????
 353          * ?    ?       : x,y:????,x=0~15,y=0~1;
 354                     str:?????
 355          * ?    ?       : ?
 356          *******************************************************************************///////////////////////////
             -///////////////////////
 357          void lcd1602_show_string(u8 x,u8 y,u8 *str)
 358          {
 359   1        u8 i=0;
 360   1      
 361   1        if(y>1||x>15)return;//???????????
 362   1      
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 7   

 363   1        if(y<1) //?1???
 364   1        { 
 365   2          while(*str!='\0')//?????'\0'??,??????????
 366   2          {
 367   3            if(i<16-x)//???????????????,?????????
 368   3            {
 369   4              lcd1602_write_cmd(0x80+i+x);//????????? 
 370   4            }
 371   3            else
 372   3            {
 373   4              lcd1602_write_cmd(0x40+0x80+i+x-16);//????????? 
 374   4            }
 375   3            lcd1602_write_data(*str);//????
 376   3            str++;//????
 377   3            i++;  
 378   3          } 
 379   2        }
 380   1        else  //?2???
 381   1        {
 382   2          while(*str!='\0')
 383   2          {
 384   3            if(i<16-x) //???????????????,?????????
 385   3            {
 386   4              lcd1602_write_cmd(0x80+0x40+i+x); 
 387   4            }
 388   3            else
 389   3            {
 390   4              lcd1602_write_cmd(0x80+i+x-16); 
 391   4            }
 392   3            lcd1602_write_data(*str);
 393   3            str++;
 394   3            i++;  
 395   3          } 
 396   2        }       
 397   1      }
 398          
 399          //??????
 400          /*******************************************************************************
 401          * ? ? ?       : key_matrix_flip_scan
 402          * ????     : ?????????,??????????,?????????
 403          * ?    ?       : ?
 404          * ?    ?       : key_value:1-16,??S1-S16?,
 405                     0:?????
 406          *******************************************************************************///////////////////////////
             -///////////////////////
 407          u8 key_matrix_flip_scan(void)
 408          {
 409   1        static u8 key_value=0;
 410   1      
 411   1        KEY_MATRIX_PORT=0x0f;//??????0,???1
 412   1        if(KEY_MATRIX_PORT!=0x0f)//????????
 413   1        {
 414   2          delay_10us(1000);//??
 415   2          if(KEY_MATRIX_PORT!=0x0f)
 416   2          {
 417   3            //???
 418   3            KEY_MATRIX_PORT=0x0f;
 419   3            switch(KEY_MATRIX_PORT)//????0,???????? 
 420   3            {
 421   4              case 0x07: key_value=1;break;
 422   4              case 0x0b: key_value=2;break;
 423   4              case 0x0d: key_value=3;break;
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 8   

 424   4              case 0x0e: key_value=4;break;
 425   4            }
 426   3            //???
 427   3            KEY_MATRIX_PORT=0xf0;
 428   3            switch(KEY_MATRIX_PORT)//????0,???????? 
 429   3            {
 430   4              case 0x70: key_value=key_value;break;
 431   4              case 0xb0: key_value=key_value+4;break;
 432   4              case 0xd0: key_value=key_value+8;break;
 433   4              case 0xe0: key_value=key_value+12;break;
 434   4            }
 435   3            while(KEY_MATRIX_PORT!=0xf0);//?????? 
 436   3          }
 437   2        }
 438   1        else
 439   1          key_value=0;    
 440   1        
 441   1        return key_value;   
 442   1      }
 443          
 444          //????????
 445          /*******************************************************************************
 446          * ? ? ?       : step_motor_28BYJ48_send_pulse
 447          * ????     : ???????ULN2003???????????????
 448          * ?    ?       : step:??????,???0~7
 449                     dir:????,1:???,0:???
 450          * ?    ?       : ?
 451          *******************************************************************************/
 452          void step_motor_28BYJ48_send_pulse(u8 step,u8 dir)
 453          {
 454   1        u8 temp=step;
 455   1        
 456   1        if(dir==0)  //????????
 457   1          temp=7-step;//??????
 458   1        switch(temp)//8?????:A->AB->B->BC->C->CD->D->DA
 459   1        {
 460   2          case 0: STEPMOTOR1=1;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=0;break;
 461   2          case 1: STEPMOTOR1=1;STEPMOTOR2=1;STEPMOTOR3=0;STEPMOTOR4=0;break;
 462   2          case 2: STEPMOTOR1=0;STEPMOTOR2=1;STEPMOTOR3=0;STEPMOTOR4=0;break;
 463   2          case 3: STEPMOTOR1=0;STEPMOTOR2=1;STEPMOTOR3=1;STEPMOTOR4=0;break;
 464   2          case 4: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=1;STEPMOTOR4=0;break;
 465   2          case 5: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=1;STEPMOTOR4=1;break;
 466   2          case 6: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=1;break;
 467   2          case 7: STEPMOTOR1=1;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=1;break;
 468   2          default: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=0;break;//???? 
 469   2        }     
 470   1      }
 471          
 472          // //????,1????,0????/////////////////////////////////////////////////////////////////////////////////////
             -/////////////
 473          // void step_motor_control(u16 input){
 474          //     if(input!=StepMotor_status)
 475          //     {
 476          //         u8 key=0;
 477          //      u8 dir=0;//???????
 478          //      u8 speed=STEPMOTOR_MAXSPEED;//????????
 479          //      u8 step=0;
 480          //         u16 time=0;
 481          //         u16 usetime=STEPMOTOR_SHIELD_HIGHT*STEPMOTOR_SHIELD_RANGE;
 482          
 483          //         if(input==1)
 484          //         {
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 9   

 485          //             while(time<=usetime){
 486          //                 step_motor_28BYJ48_send_pulse(step++,dir);
 487          //                time++;
 488          //                if(step==8)step=0;    
 489          //                delay_10us(speed);
 490          //             }
 491          //      StepMotor_status=1;
 492          //         }
 493          //         if(input==0)
 494          //         {
 495          //             dir=!dir;
 496          //             while(time<=usetime){
 497          //                 step_motor_28BYJ48_send_pulse(step++,dir);
 498          //                time++;
 499          //                if(step==8)step=0;    
 500          //                delay_10us(speed);
 501          //             }
 502          //      StepMotor_status=0;
 503          //         }
 504          //     }
 505          // }
 506          
 507          //?????????
 508          /*******************************************************************************
 509          * ? ? ?         : ds18b20_reset
 510          * ????       : ??DS18B20  
 511          * ?    ?         : ?
 512          * ?    ?         : ?
 513          *******************************************************************************/
 514          void ds18b20_reset(void)
 515          {
 516   1        TEMPATURE=0;  //??DQ
 517   1        delay_10us(75); //??750us
 518   1        TEMPATURE=1;  //DQ=1
 519   1        delay_10us(2);  //20US
 520   1      }
 521          
 522          /*******************************************************************************
 523          * ? ? ?         : ds18b20_check
 524          * ????       : ??DS18B20????
 525          * ?    ?         : ?
 526          * ?    ?         : 1:????DS18B20???,0:??
 527          *******************************************************************************/
 528          u8 ds18b20_check(void)
 529          {
 530   1        u8 time_temp=0;
 531   1      
 532   1        while(TEMPATURE&&time_temp<20)  //??DQ????
 533   1        {
 534   2          time_temp++;
 535   2          delay_10us(1);  
 536   2        }
 537   1        if(time_temp>=20)return 1;  //?????????1
 538   1        else time_temp=0;
 539   1        while((!TEMPATURE)&&time_temp<20) //??DQ????
 540   1        {
 541   2          time_temp++;
 542   2          delay_10us(1);
 543   2        }
 544   1        if(time_temp>=20)return 1;  //?????????1
 545   1        return 0;
 546   1      }
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 10  

 547          
 548          /*******************************************************************************
 549          * ? ? ?         : ds18b20_read_bit
 550          * ????       : ?DS18B20?????
 551          * ?    ?         : ?
 552          * ?    ?         : 1/0
 553          *******************************************************************************/
 554          u8 ds18b20_read_bit(void)
 555          {
 556   1        u8 dat=0;
 557   1        
 558   1        TEMPATURE=0;
 559   1        _nop_();_nop_();
 560   1        TEMPATURE=1;  
 561   1        _nop_();_nop_(); //????????,???15us?????
 562   1        if(TEMPATURE)dat=1; //??????1???dat?1,???0
 563   1        else dat=0;
 564   1        delay_10us(5);
 565   1        return dat;
 566   1      } 
 567          
 568          /*******************************************************************************
 569          * ? ? ?         : ds18b20_read_byte
 570          * ????       : ?DS18B20??????
 571          * ?    ?         : ?
 572          * ?    ?         : ??????
 573          *******************************************************************************/
 574          u8 ds18b20_read_byte(void)
 575          {
 576   1        u8 i=0;
 577   1        u8 dat=0;
 578   1        u8 temp=0;
 579   1      
 580   1        for(i=0;i<8;i++)//??8?,??????,?????????
 581   1        {
 582   2          temp=ds18b20_read_bit();
 583   2          dat=(temp<<7)|(dat>>1);
 584   2        }
 585   1        return dat; 
 586   1      }
 587          
 588          /*******************************************************************************
 589          * ? ? ?         : ds18b20_write_byte
 590          * ????       : ??????DS18B20
 591          * ?    ?         : dat:??????
 592          * ?    ?         : ?
 593          *******************************************************************************/
 594          void ds18b20_write_byte(u8 dat)
 595          {
 596   1        u8 i=0;
 597   1        u8 temp=0;
 598   1      
 599   1        for(i=0;i<8;i++)//??8?,?????,?????????
 600   1        {
 601   2          temp=dat&0x01;//????????
 602   2          dat>>=1;//????????
 603   2          if(temp)
 604   2          {
 605   3            TEMPATURE=0;
 606   3            _nop_();_nop_();
 607   3            TEMPATURE=1;  
 608   3            delay_10us(6);
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 11  

 609   3          }
 610   2          else
 611   2          {
 612   3            TEMPATURE=0;
 613   3            delay_10us(6);
 614   3            TEMPATURE=1;
 615   3            _nop_();_nop_();  
 616   3          } 
 617   2        } 
 618   1      }
 619          
 620          /*******************************************************************************
 621          * ? ? ?         : ds18b20_start
 622          * ????       : ??????
 623          * ?    ?         : ?
 624          * ?    ?         : ?
 625          *******************************************************************************/
 626          void ds18b20_start(void)
 627          {
 628   1        ds18b20_reset();//??
 629   1        ds18b20_check();//??DS18B20
 630   1        ds18b20_write_byte(0xcc);//SKIP ROM
 631   1          ds18b20_write_byte(0x44);//???? 
 632   1      }
 633          
 634          /*******************************************************************************
 635          * ? ? ?         : ds18b20_init
 636          * ????       : ???DS18B20?IO? DQ ????DS???
 637          * ?    ?         : ?
 638          * ?    ?         : 1:???,0:??
 639          *******************************************************************************///////////////////////////
             -///////////////////////
 640          u8 ds18b20_init(void)
 641          {
 642   1        ds18b20_reset();
 643   1        return ds18b20_check(); 
 644   1      }
 645          
 646          /*******************************************************************************
 647          * ? ? ?         : ds18b20_read_temperture
 648          * ????       : ?ds18b20?????
 649          * ?    ?         : ?
 650          * ?    ?         : ????
 651          *******************************************************************************///////////////////////////
             -///////////////////////
 652          // float temperature_read(void)
 653          // {
 654          //  float temp;
 655          //  u8 dath=0;
 656          //  u8 datl=0;
 657          //  u16 value=0;
 658          
 659          //  ds18b20_start();//????
 660          //  ds18b20_reset();//??
 661          //  ds18b20_check();
 662          //  ds18b20_write_byte(0xcc);//SKIP ROM
 663          //     ds18b20_write_byte(0xbe);//????
 664          
 665          //  datl=ds18b20_read_byte();//???
 666          //  dath=ds18b20_read_byte();//???
 667          //  value=(dath<<8)+datl;//???16???
 668          
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 12  

 669          //  if((value&0xf800)==0xf800)//?????,???
 670          //  {
 671          //    value=(~value)+1; //??????1
 672          //    temp=value*(-0.0625);//???? 
 673          //  }
 674          //  else //???
 675          //  {
 676          //    temp=value*0.0625;  
 677          //  }
 678          //  return temp;
 679          // }
 680          
 681          //???????????
 682          //??DHT11
 683          void DHT11_Rst(void)     
 684          {                 
 685   1        MOISTURE_AIR=1;
 686   1        delay_10us(1);
 687   1        MOISTURE_AIR=0;   //??DQ
 688   1          delay_ms(25);   //????18ms
 689   1          MOISTURE_AIR=1;   //DQ=1 
 690   1        delay_10us(3);  //????20~40us
 691   1      }
 692          //??DHT11???
 693          //??1:????DHT11???
 694          //??0:??
 695          u8 DHT11_Check(void)     
 696          {   
 697   1        u8 retry=0;
 698   1        
 699   1        while (!MOISTURE_AIR&&retry<100)//?????? 80us ????????????
 700   1        {
 701   2          retry++;
 702   2          _nop_();
 703   2        };
 704   1        if(retry>=100)return 1;
 705   1        else retry=0;
 706   1          while (MOISTURE_AIR&&retry<100)//?????? 80us ?????????H??????????????
 707   1        {
 708   2          retry++;
 709   2          _nop_();
 710   2        };   
 711   1        if(retry>=100)return 1;     
 712   1        return 0;
 713   1      }
 714          
 715          
 716          //DHT11??? ///////////////////////////////////////////////////////////////////////////////////////////////
             -///
 717          //??0:?????,1:??
 718          u8 DHT11_Init(void)
 719          {
 720   1        MOISTURE_AIR=1;
 721   1        DHT11_Rst();    
 722   1        return DHT11_Check(); 
 723   1      }
 724          
 725          //?DHT11??????
 726          //???:?????
 727          u8 DHT11_Read_Byte(void)    
 728          {        
 729   1          u8 i,temp;
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 13  

 730   1        u8 data_byte=0; 
 731   1        u8 retry=0;
 732   1      
 733   1          for(i=0;i<8;i++)//??8bit??? 
 734   1          { 
 735   2      //    while(!MOISTURE_AIR);//??50us??????????
 736   2          while (!MOISTURE_AIR&&retry<50)//??50us??????????
 737   2          {
 738   3            retry++;
 739   3            _nop_();
 740   3          };
 741   2          retry=0; 
 742   2          delay_10us(3);//??40us 
 743   2          temp=0;//???26us-28us?1????????'0' 
 744   2          if(MOISTURE_AIR==1) 
 745   2            temp=1; //??26us-28us???;??????T?????????'1' 
 746   2      //    while(MOISTURE_AIR);//???????????'0'?26us-28us??'1'?70us
 747   2          while (MOISTURE_AIR&&retry<100)//???????????'0'?26us-28us??'1'?70us
 748   2          {
 749   3            retry++;
 750   3            _nop_();
 751   3          };
 752   2          data_byte<<=1;//??????????????? 
 753   2          data_byte|=temp; 
 754   2          } 
 755   1      
 756   1          return data_byte;
 757   1      }
 758          
 759          // //?DHT11??????/////////////////////////////////////////////////////////////////////////////////////////
             -/////////
 760          // //temp:???(??:0~50°)
 761          // //humi:???(??:20%~90%)
 762          // //???:0,??;1,????
 763          // u8 air_moisture_read(u8 *temp,u8 *humi)    
 764          // {        
 765          //    u8 buf[5];
 766          //  u8 i;
 767          //  DHT11_Rst();
 768          //  if(DHT11_Check()==0)
 769          //  {
 770          //    for(i=0;i<5;i++)//??40???
 771          //    {
 772          //      buf[i]=DHT11_Read_Byte();
 773          //    }
 774          //    if((buf[0]+buf[1]+buf[2]+buf[3])==buf[4])
 775          //    {
 776          //      *humi=buf[0];
 777          //      *temp=buf[2];
 778          //    }
 779              
 780          //  }else return 1;
 781          //  return 0;     
 782          // }
 783          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 784          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 785          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 786          
 787          //????
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 14  

 788          float temperature_read(void)
 789          {
 790   1        float temp;
 791   1        u8 dath=0;
 792   1        u8 datl=0;
 793   1        u16 value=0;
 794   1      
 795   1        ds18b20_start();//????
 796   1        ds18b20_reset();//??
 797   1        ds18b20_check();
 798   1        ds18b20_write_byte(0xcc);//SKIP ROM
 799   1          ds18b20_write_byte(0xbe);//????
 800   1      
 801   1        datl=ds18b20_read_byte();//???
 802   1        dath=ds18b20_read_byte();//???
 803   1        value=(dath<<8)+datl;//???16???
 804   1      
 805   1        if((value&0xf800)==0xf800)//?????,???
 806   1        {
 807   2          value=(~value)+1; //??????1
 808   2          temp=value*(-0.0625);//???? 
 809   2        }
 810   1        else //???
 811   1        {
 812   2          temp=value*0.0625;  
 813   2        }
 814   1        return temp;
 815   1      }
 816          
 817          //?????????
 818          u8 soil_moisture_read(void)
 819          {
 820   1        u8 soil_moisture_adc;
 821   1        soil_moisture_adc=ADC_read_data(0);
 822   1        return soil_moisture_adc;
 823   1      }
 824          //???????
 825          u8 water_lavel_read(void)
 826          {
 827   1        u8 water_lavel_adc;
 828   1        water_lavel_adc=ADC_read_data(1);
 829   1        return water_lavel_adc;
 830   1      }
 831          
 832          //?DHT11??????
 833          //temp:???
 834          //humi:???
 835          u8 air_moisture_read(void)    
 836          {        
 837   1        u8 buf[5];
 838   1        u8 i;
 839   1        DHT11_Rst();
 840   1        if(DHT11_Check()==0)
 841   1        {
 842   2          for(i=0;i<5;i++)//??40???
 843   2          {
 844   3            buf[i]=DHT11_Read_Byte();
 845   3          }
 846   2          if((buf[0]+buf[1]+buf[2]+buf[3])==buf[4])
 847   2          {
 848   3            humi=buf[0];
 849   3            temp=buf[2];
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 15  

 850   3          }
 851   2          
 852   2        }   
 853   1      }
*** WARNING C173 IN LINE 853 OF main.c: missing return-expression
 854          
 855          //??????
 856          u8 light_intensity_read(void)
 857          {
 858   1        u8 light_value_adc;
 859   1        light_value_adc=xpt2046_read_adc_value(0xE4);
 860   1        return light_value_adc;
 861   1      }
 862          
 863          //???????,1????,0????
 864          void step_motor_control(u16 input){
 865   1          if(input!=StepMotor_status)
 866   1          {
 867   2              u8 key=0;
 868   2            u8 dir=0;//???????
 869   2            u8 speed=STEPMOTOR_MAXSPEED;//????????
 870   2            u8 step=0;
 871   2              u16 time=0;
 872   2              u16 usetime=STEPMOTOR_SHIELD_HIGHT*STEPMOTOR_SHIELD_RANGE;
 873   2      
 874   2              if(input==1)
 875   2              {
 876   3                  while(time<=usetime){
 877   4                      step_motor_28BYJ48_send_pulse(step++,dir);
 878   4                      time++;
 879   4                      if(step==8)step=0;    
 880   4                      delay_ms(speed);
 881   4                  }
 882   3            StepMotor_status=1;
 883   3              }
 884   2              if(input==0)
 885   2              {
 886   3                  dir=!dir;
 887   3                  while(time<=usetime){
 888   4                      step_motor_28BYJ48_send_pulse(step++,dir);
 889   4                      time++;
 890   4                      if(step==8)step=0;    
 891   4                      delay_ms(speed);
 892   4                  }
 893   3            StepMotor_status=0;
 894   3              }
 895   2          }
 896   1      }
 897          
 898          //??????,????????
 899          void pump_control(u16 input)
 900          {
 901   1          PUMP=1;
 902   1          delay_ms(input);
 903   1          PUMP=0;
 904   1      }
 905          
 906          //???????,1??,0??
 907          void spray_control(u16 input)
 908          {
 909   1          SPRAY=input;
 910   1      }
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 16  

 911          
 912          //???????,1??,0??
 913          void light_control(u16 input)
 914          {
 915   1          LIGHT=input;
 916   1      }
 917          
 918          
 919          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 920          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 921          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 922          
 923          void all_data_read(void)
 924          {
 925   1        //??
 926   1        temp_value=temperature_read()*10;
 927   1      
 928   1        if(temp_value<0)
 929   1        {
 930   2          temp_value=-temp_value;
 931   2          temp_buf[0]='-';  
 932   2        }
 933   1        else
 934   1          temp_buf[0]=' ';
 935   1        if(temp_value>=1000)
 936   1          temp_buf[1]=temp_value/1000+0x30;
 937   1        else
 938   1          temp_buf[1]=' ';
 939   1        temp_buf[2]=temp_value%1000/100+0x30;
 940   1        temp_buf[3]=temp_value%1000%100/10+0x30;
 941   1        temp_buf[4]='.';
 942   1        temp_buf[5]=temp_value%1000%100%10+0x30;
 943   1        temp_buf[6]='C';
 944   1        temp_buf[7]='\0'; 
 945   1      
 946   1        //????
 947   1        soil_moisture=soil_moisture_read();
 948   1      
 949   1        soil_moisture_buf[0]=soil_moisture%1000/100+0x30;
 950   1        soil_moisture_buf[1]=soil_moisture%1000%100/10+0x30;
 951   1        soil_moisture_buf[2]=soil_moisture%1000%100%10+0x30;
 952   1        soil_moisture_buf[3]='\0';
 953   1      
 954   1        //????
 955   1        water_lavel=water_lavel_read();
 956   1      
 957   1        water_lavel_buf[0]=water_lavel%1000/100+0x30;
 958   1        water_lavel_buf[1]=water_lavel%1000%100/10+0x30;
 959   1        water_lavel_buf[2]=water_lavel%1000%100%10+0x30;
 960   1        water_lavel_buf[3]='\0';
 961   1      
 962   1        //????
 963   1        air_moisture_read();
 964   1        temp_buf2[0]=temp/10+0x30;  
 965   1        temp_buf2[1]=temp%10+0x30;
 966   1        temp_buf2[2]='\0';
 967   1      
 968   1        humi_buf[0]=humi/10+0x30; 
 969   1        humi_buf[1]=humi%10+0x30;
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 17  

 970   1        humi_buf[2]='\0';
 971   1      
 972   1        //????
 973   1        light_intensity=light_intensity_read();
 974   1        light_intensity_buf[0]=light_intensity%1000/100+0x30;
 975   1        light_intensity_buf[1]=light_intensity%1000%100/10+0x30;
 976   1        light_intensity_buf[2]=light_intensity%1000%100%10+0x30;
 977   1        light_intensity_buf[3]='\0';
 978   1      }
 979          
 980          void all_init(void)
 981          {
 982   1        lcd1602_init();
 983   1        lcd1602_show_string(0,0,"Self-testing");
 984   1        stay_time=0;
 985   1        ds18b20_init();
 986   1        DHT11_Init();
 987   1        pump_control(500);
 988   1        spray_control(0);
 989   1        light_control(0);
 990   1        allow_test2=0;
 991   1        lcd1602_init();
 992   1        lcd1602_show_string(0,0,"Self-test");
 993   1        lcd1602_show_string(0,1,"Success!!!");
 994   1      }
 995          
 996          
 997          
 998          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 999          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
1000          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
1001          //??????
1002          void test1(void)
1003          {
1004   1        key=key_matrix_flip_scan();
1005   1        switch(key)
1006   1        {
1007   2          case(1):{
1008   3            lcd1602_init();
1009   3            lcd1602_show_string(0,0,"Temperature:");//?????
1010   3            lcd1602_show_string(0,1,temp_buf);//?????
1011   3            break;  
1012   3          }
1013   2          case(2):{
1014   3            lcd1602_init();
1015   3            lcd1602_show_string(0,0,"Soil Moisture:");//?????
1016   3            lcd1602_show_string(0,1,soil_moisture_buf);//?????
1017   3            break;  
1018   3          }
1019   2          case(3):{
1020   3            lcd1602_init();
1021   3            lcd1602_show_string(0,0,"Water Level:");//?????
1022   3            lcd1602_show_string(0,1,water_lavel_buf);//?????
1023   3            break;  
1024   3          }
1025   2          case(4):{
1026   3            lcd1602_init();
1027   3            lcd1602_show_string(0,0,"Air Moisture:");//?????
1028   3            lcd1602_show_string(0,1,humi_buf);//?????
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 18  

1029   3            break;  
1030   3          }
1031   2          case(5):{
1032   3            lcd1602_init();
1033   3            lcd1602_show_string(0,0,"Light Intensity:");//?????
1034   3            lcd1602_show_string(0,1,light_intensity_buf);//?????
1035   3            break;  
1036   3          }
1037   2          case(6):{
1038   3            lcd1602_init();
1039   3            lcd1602_show_string(0,0,"Shield Rising");
1040   3            step_motor_control(1);
1041   3            lcd1602_init();
1042   3            lcd1602_show_string(0,0,"Shield Rised");
1043   3            break;  
1044   3          }
1045   2          case(7):{
1046   3            lcd1602_init();
1047   3            lcd1602_show_string(0,0,"Shield Falling");
1048   3            step_motor_control(0);
1049   3            lcd1602_init();
1050   3            lcd1602_show_string(0,0,"Shield Falled");
1051   3            break;  
1052   3          }
1053   2          case(8):{
1054   3            lcd1602_init();
1055   3            lcd1602_show_string(0,0,"Pump Working");
1056   3            pump_control(5000);
1057   3            lcd1602_show_string(0,0,"Pump Worked 5s");
1058   3            break;  
1059   3          }
1060   2          case(9):{
1061   3            lcd1602_init();
1062   3            lcd1602_show_string(0,0,"Spray Work Begin");
1063   3            spray_control(1);
1064   3            break;  
1065   3          }
1066   2          case(10):{
1067   3            lcd1602_init();
1068   3            lcd1602_show_string(0,0,"Spray Work Stop");
1069   3            spray_control(0);
1070   3            break;  
1071   3          }
1072   2          case(11):{
1073   3            lcd1602_init();
1074   3            lcd1602_show_string(0,0,"LED Work Begin");
1075   3            light_control(1);
1076   3            break;  
1077   3          }
1078   2          case(12):{
1079   3            lcd1602_init();
1080   3            lcd1602_show_string(0,0,"LED Work Stop");
1081   3            light_control(0);
1082   3            break;  
1083   3          }
1084   2          case(13):{
1085   3            lcd1602_init();
1086   3            lcd1602_show_string(0,0,"AUTO Work Begin");
1087   3            allow_test2=1;
1088   3            break;  
1089   3          }
1090   2          case(14):{
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 19  

1091   3            lcd1602_init();
1092   3            lcd1602_show_string(0,0,"AUTO Work Stop");
1093   3            allow_test2=0;
1094   3            break;  
1095   3          }
1096   2          case(15):{
1097   3            all_init();
1098   3            break;  
1099   3          }
1100   2          case(16):{
1101   3            break;  
1102   3          }
1103   2          default:{
1104   3            break;
1105   3          }
1106   2        }
1107   1      }
1108          
1109          u16 need_temp=270;
1110          u16 need_light_intensity=128;
1111          u16 need_soil_moisture=0;
1112          u16 need_air_moisture=23;
1113          
1114          void test2(void){
1115   1        if(temp_value > need_temp)
1116   1          step_motor_control(1);
1117   1        if(temp_value < need_temp)
1118   1          step_motor_control(0);
1119   1      
1120   1        if(light_intensity > need_light_intensity)
1121   1          light_control(1);
1122   1        if(light_intensity < need_light_intensity)
1123   1          light_control(0);
1124   1      
1125   1        if(humi < need_air_moisture)
1126   1          spray_control(1);
1127   1        if(humi > need_air_moisture)
1128   1          spray_control(0);
1129   1      
1130   1      
1131   1      }
1132          
1133          
1134          
1135          
1136          
1137          int main()
1138          {
1139   1        all_init();
1140   1        while(1)
1141   1        {
1142   2          stay_time++;
1143   2          if(stay_time==22000)
1144   2          {
1145   3            all_data_read();
1146   3            stay_time=0;
1147   3          }
1148   2          test1();
1149   2          if(allow_test2)
1150   2            test2();
1151   2      
1152   2        }
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:43:54 PAGE 20  

1153   1      }
*** WARNING C290 IN LINE 853 OF main.c: missing return value


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2537    ----
   CONSTANT SIZE    =    283    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     53      25
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
