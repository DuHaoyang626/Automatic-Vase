C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Program Files\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include"reg52.h"
   2          #include "intrins.h"
   3          
   4          
   5          //????
   6          typedef unsigned int u16;
   7          typedef unsigned char u8;
   8          
   9          
  10          //????
  11          
  12          #define LCD1602_DATAPORT P0//LCD????
  13          
  14          #define KEY_MATRIX_PORT P1//???????
  15          
  16          sbit PUMP=P2^0;//????P2^0
  17          sbit SPRAY=P2^1;//?????2^1
  18          sbit LIGHT=P2^2;//LED?????P2^2
  19          sbit MOISTURE_AIR=P2^3;//?????????P2^3
  20          sbit TEMPATURE=P2^4;//???????P2^4
  21          sbit LCD1602_RW=P2^5;//LCD????
  22          sbit LCD1602_RS=P2^6;//LCD??????
  23          sbit LCD1602_E=P2^7; //LCD????
  24          
  25          sbit STEPMOTOR1=P3^0;//????1??P3^0,????
  26          sbit STEPMOTOR2=P3^1;//????2??P3^1,????
  27          sbit STEPMOTOR3=P3^2;//????3??P3^2,????
  28          sbit STEPMOTOR4=P3^3;//????4??P3^3,????
  29          sbit DIN  = P3^4;   //ADC??
  30          sbit CS   = P3^5;   //ADC??
  31          sbit CLK  = P3^6;   //ADC??
  32          sbit DOUT = P3^7;   //ADC??
  33          // 
  34          // sbit MOISTURE_SOIL=P3^1;//?????????ADC
  35          // sbit WATER_LEVEL=P3^2;//???????ADC^E4
  36          //sbit LIGHT_INTENSITY=P2^4;//?????????ADC^A4
  37          //sbit WIFI_IO=P2^0;//??WIFI??????
  38          
  39          //????
  40          
  41          //LCD1602???4??8???,??1,??LCD1602???????,???8?
  42          #define LCD1602_4OR8_DATA_INTERFACE 0 //????8????LCD1602
  43          
  44          // ????????,???,????
  45          #define STEPMOTOR_MAXSPEED        100//????????,????1
  46          #define STEPMOTOR_MINSPEED        350//????????
  47          #define STEPMOTOR_SHIELD_HIGHT    10//?????
  48          #define STEPMOTOR_SHIELD_RANGE    300//?????????
  49          u16 StepMotor_status=0;//???????????,0?????,1?????
  50          
  51          //????
  52          
  53          //????,??int x,??x/100??
  54          void delay_10us(u16 ten_us){
  55   1      while(ten_us--);
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 2   

  56   1      }
  57          
  58          //????,??int x,??x??
  59          void delay_ms(u16 ms)
  60          {
  61   1        u16 i,j;
  62   1        for(i=ms;i>0;i--)
  63   1          for(j=110;j>0;j--);
  64   1      }
  65          
  66          //????????
  67          /*******************************************************************************
  68          * ? ? ?       : xpt2046_wirte_data
  69          * ????     : XPT2046???
  70          * ?    ?       : dat:?????
  71          * ?    ?       : ?
  72          *******************************************************************************/
  73          void xpt2046_wirte_data(u8 dat)
  74          {
  75   1        u8 i;
  76   1      
  77   1        CLK = 0;
  78   1        _nop_();
  79   1        for(i=0;i<8;i++)//??8?,??????,?????
  80   1        {
  81   2          DIN = dat >> 7;//????????
  82   2          dat <<= 1;//???????
  83   2          CLK = 0;//CLK???????????,??????
  84   2          _nop_();  
  85   2          CLK = 1;
  86   2          _nop_();
  87   2        }
  88   1      }
  89          
  90          /*******************************************************************************
  91          * ? ? ?       : xpt2046_read_data
  92          * ????     : XPT2046???
  93          * ?    ?       : ?
  94          * ?    ?       : XPT2046??12???
  95          *******************************************************************************/
  96          u16 xpt2046_read_data(void)
  97          {
  98   1        u8 i;
  99   1        u16 dat=0;
 100   1      
 101   1        CLK = 0;
 102   1        _nop_();
 103   1        for(i=0;i<12;i++)//??12?,??????,???????,????????u16
 104   1        {
 105   2          dat <<= 1;
 106   2          CLK = 1;
 107   2          _nop_();
 108   2          CLK = 0; //CLK???????????,??????
 109   2          _nop_();
 110   2          dat |= DOUT;//?????,??????  
 111   2        }
 112   1        return dat; 
 113   1      }
 114          
 115          /*******************************************************************************
 116          * ? ? ?       : xpt2046_read_adc_value
 117          * ????     : XPT2046?AD??
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 3   

 118          * ?    ?       : cmd:??
 119          * ?    ?       : XPT2046??AD?
 120          *******************************************************************************///////////////////////////
             -///////////////////////
 121          u16 xpt2046_read_adc_value(u8 cmd)
 122          {
 123   1        u8 i;
 124   1        u16 adc_value=0;
 125   1      
 126   1        CLK = 0;//?????
 127   1        CS  = 0;//??XPT2046
 128   1        xpt2046_wirte_data(cmd);//?????
 129   1        for(i=6; i>0; i--);//????????
 130   1        CLK = 1;
 131   1        _nop_();
 132   1        CLK = 0;//??????,??BUSY
 133   1        _nop_();
 134   1        adc_value=xpt2046_read_data();
 135   1        CS = 1;//??XPT2046
 136   1        return adc_value;
 137   1      }
 138          
 139          //LCD????
 140          /*******************************************************************************
 141          * ? ? ?       : lcd1602_write_cmd
 142          * ????     : LCD1602???
 143          * ?    ?       : cmd:??
 144          * ?    ?       : ?
 145          *******************************************************************************/
 146          #if (LCD1602_4OR8_DATA_INTERFACE==0)//8?LCD
 147          void lcd1602_write_cmd(u8 cmd)
 148          {
 149   1        LCD1602_RS=0;//????
 150   1        LCD1602_RW=0;//???
 151   1        LCD1602_E=0;
 152   1        LCD1602_DATAPORT=cmd;//????
 153   1        delay_ms(1);
 154   1        LCD1602_E=1;//???E??????
 155   1        delay_ms(1);
 156   1        LCD1602_E=0;//???E????????  
 157   1      }
 158          #else //4?LCD
              void lcd1602_write_cmd(u8 cmd)
              {
                LCD1602_RS=0;//????
                LCD1602_RW=0;//???
                LCD1602_E=0;
                LCD1602_DATAPORT=cmd;//????
                delay_ms(1);
                LCD1602_E=1;//???E??????
                delay_ms(1);
                LCD1602_E=0;//???E????????
                
                LCD1602_DATAPORT=cmd<<4;//????
                delay_ms(1);
                LCD1602_E=1;//???E??????
                delay_ms(1);
                LCD1602_E=0;//???E????????  
              }
              #endif
 177          
 178          /*******************************************************************************
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 4   

 179          * ? ? ?       : lcd1602_write_data
 180          * ????     : LCD1602???
 181          * ?    ?       : dat:??
 182          * ?    ?       : ?
 183          *******************************************************************************/
 184          #if (LCD1602_4OR8_DATA_INTERFACE==0)//8?LCD
 185          void lcd1602_write_data(u8 dat) 
 186          {
 187   1        LCD1602_RS=1;//????
 188   1        LCD1602_RW=0;//???
 189   1        LCD1602_E=0;
 190   1        LCD1602_DATAPORT=dat;//????
 191   1        delay_ms(1);
 192   1        LCD1602_E=1;//???E??????
 193   1        delay_ms(1);
 194   1        LCD1602_E=0;//???E????????    
 195   1      }
 196          #else
              void lcd1602_write_data(u8 dat) 
              {
                LCD1602_RS=1;//????
                LCD1602_RW=0;//???
                LCD1602_E=0;
                LCD1602_DATAPORT=dat;//????
                delay_ms(1);
                LCD1602_E=1;//???E??????
                delay_ms(1);
                LCD1602_E=0;//???E????????
                
                LCD1602_DATAPORT=dat<<4;//????
                delay_ms(1);
                LCD1602_E=1;//???E??????
                delay_ms(1);
                LCD1602_E=0;//???E????????    
              }
              #endif
 215          
 216          /*******************************************************************************
 217          * ? ? ?       : lcd1602_init
 218          * ????     : LCD1602???
 219          * ?    ?       : ?
 220          * ?    ?       : ?
 221          *******************************************************************************///////////////////////////
             -///////////////////////
 222          #if (LCD1602_4OR8_DATA_INTERFACE==0)//8?LCD
 223          void lcd1602_init(void)
 224          {
 225   1        lcd1602_write_cmd(0x38);//????8?,??2?,5*7??/??
 226   1        lcd1602_write_cmd(0x0c);//?????,???,????
 227   1        lcd1602_write_cmd(0x06);//??????????,??????
 228   1        lcd1602_write_cmd(0x01);//??  
 229   1      }
 230          #else
              void lcd1602_init(void)
              {
                lcd1602_write_cmd(0x28);//????4?,??2?,5*7??/??
                lcd1602_write_cmd(0x0c);//?????,???,????
                lcd1602_write_cmd(0x06);//??????????,??????
                lcd1602_write_cmd(0x01);//??  
              }
              #endif
 239          
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 5   

 240          /*******************************************************************************
 241          * ? ? ?       : lcd1602_clear
 242          * ????     : LCD1602??
 243          * ?    ?       : ?
 244          * ?    ?       : ?
 245          *******************************************************************************/
 246          void lcd1602_clear(void)
 247          {
 248   1        lcd1602_write_cmd(0x01);  
 249   1      }
 250          
 251          /*******************************************************************************
 252          * ? ? ?       : lcd1602_show_string
 253          * ????     : LCD1602????
 254          * ?    ?       : x,y:????,x=0~15,y=0~1;
 255                     str:?????
 256          * ?    ?       : ?
 257          *******************************************************************************///////////////////////////
             -///////////////////////
 258          void lcd1602_show_string(u8 x,u8 y,u8 *str)
 259          {
 260   1        u8 i=0;
 261   1      
 262   1        if(y>1||x>15)return;//???????????
 263   1      
 264   1        if(y<1) //?1???
 265   1        { 
 266   2          while(*str!='\0')//?????'\0'??,??????????
 267   2          {
 268   3            if(i<16-x)//???????????????,?????????
 269   3            {
 270   4              lcd1602_write_cmd(0x80+i+x);//????????? 
 271   4            }
 272   3            else
 273   3            {
 274   4              lcd1602_write_cmd(0x40+0x80+i+x-16);//????????? 
 275   4            }
 276   3            lcd1602_write_data(*str);//????
 277   3            str++;//????
 278   3            i++;  
 279   3          } 
 280   2        }
 281   1        else  //?2???
 282   1        {
 283   2          while(*str!='\0')
 284   2          {
 285   3            if(i<16-x) //???????????????,?????????
 286   3            {
 287   4              lcd1602_write_cmd(0x80+0x40+i+x); 
 288   4            }
 289   3            else
 290   3            {
 291   4              lcd1602_write_cmd(0x80+i+x-16); 
 292   4            }
 293   3            lcd1602_write_data(*str);
 294   3            str++;
 295   3            i++;  
 296   3          } 
 297   2        }       
 298   1      }
 299          
 300          //??????
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 6   

 301          /*******************************************************************************
 302          * ? ? ?       : key_matrix_flip_scan
 303          * ????     : ?????????,??????????,?????????
 304          * ?    ?       : ?
 305          * ?    ?       : key_value:1-16,??S1-S16?,
 306                     0:?????
 307          *******************************************************************************///////////////////////////
             -///////////////////////
 308          u8 key_matrix_flip_scan(void)
 309          {
 310   1        static u8 key_value=0;
 311   1      
 312   1        KEY_MATRIX_PORT=0x0f;//??????0,???1
 313   1        if(KEY_MATRIX_PORT!=0x0f)//????????
 314   1        {
 315   2          delay_10us(1000);//??
 316   2          if(KEY_MATRIX_PORT!=0x0f)
 317   2          {
 318   3            //???
 319   3            KEY_MATRIX_PORT=0x0f;
 320   3            switch(KEY_MATRIX_PORT)//????0,???????? 
 321   3            {
 322   4              case 0x07: key_value=1;break;
 323   4              case 0x0b: key_value=2;break;
 324   4              case 0x0d: key_value=3;break;
 325   4              case 0x0e: key_value=4;break;
 326   4            }
 327   3            //???
 328   3            KEY_MATRIX_PORT=0xf0;
 329   3            switch(KEY_MATRIX_PORT)//????0,???????? 
 330   3            {
 331   4              case 0x70: key_value=key_value;break;
 332   4              case 0xb0: key_value=key_value+4;break;
 333   4              case 0xd0: key_value=key_value+8;break;
 334   4              case 0xe0: key_value=key_value+12;break;
 335   4            }
 336   3            while(KEY_MATRIX_PORT!=0xf0);//?????? 
 337   3          }
 338   2        }
 339   1        else
 340   1          key_value=0;    
 341   1        
 342   1        return key_value;   
 343   1      }
 344          
 345          //????????
 346          /*******************************************************************************
 347          * ? ? ?       : step_motor_28BYJ48_send_pulse
 348          * ????     : ???????ULN2003???????????????
 349          * ?    ?       : step:??????,???0~7
 350                     dir:????,1:???,0:???
 351          * ?    ?       : ?
 352          *******************************************************************************/
 353          void step_motor_28BYJ48_send_pulse(u8 step,u8 dir)
 354          {
 355   1        u8 temp=step;
 356   1        
 357   1        if(dir==0)  //????????
 358   1          temp=7-step;//??????
 359   1        switch(temp)//8?????:A->AB->B->BC->C->CD->D->DA
 360   1        {
 361   2          case 0: STEPMOTOR1=1;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=0;break;
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 7   

 362   2          case 1: STEPMOTOR1=1;STEPMOTOR2=1;STEPMOTOR3=0;STEPMOTOR4=0;break;
 363   2          case 2: STEPMOTOR1=0;STEPMOTOR2=1;STEPMOTOR3=0;STEPMOTOR4=0;break;
 364   2          case 3: STEPMOTOR1=0;STEPMOTOR2=1;STEPMOTOR3=1;STEPMOTOR4=0;break;
 365   2          case 4: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=1;STEPMOTOR4=0;break;
 366   2          case 5: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=1;STEPMOTOR4=1;break;
 367   2          case 6: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=1;break;
 368   2          case 7: STEPMOTOR1=1;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=1;break;
 369   2          default: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=0;break;//???? 
 370   2        }     
 371   1      }
 372          
 373          //????,1????,0????////////////////////////////////////////////////////////////////////////////////////////
             -//////////
 374          void step_motor_control(u16 input){
 375   1          if(input!=StepMotor_status)
 376   1          {
 377   2              u8 key=0;
 378   2            u8 dir=0;//???????
 379   2            u8 speed=STEPMOTOR_MAXSPEED;//????????
 380   2            u8 step=0;
 381   2              u16 time=0;
 382   2              u16 usetime=STEPMOTOR_SHIELD_HIGHT*STEPMOTOR_SHIELD_RANGE;
 383   2      
 384   2              if(input==1)
 385   2              {
 386   3                  while(time<=usetime){
 387   4                      step_motor_28BYJ48_send_pulse(step++,dir);
 388   4                      time++;
 389   4                      if(step==8)step=0;    
 390   4                      delay_10us(speed);
 391   4                  }
 392   3            StepMotor_status=1;
 393   3              }
 394   2              if(input==0)
 395   2              {
 396   3                  dir=!dir;
 397   3                  while(time<=usetime){
 398   4                      step_motor_28BYJ48_send_pulse(step++,dir);
 399   4                      time++;
 400   4                      if(step==8)step=0;    
 401   4                      delay_10us(speed);
 402   4                  }
 403   3            StepMotor_status=0;
 404   3              }
 405   2          }
 406   1      }
 407          
 408          //??????,????????/////////////////////////////////////////////////////////////////////////////////////////
             -/////////
 409          void pump_control(u16 input)
 410          {
 411   1          PUMP=1;
 412   1          delay_ms(input);
 413   1          PUMP=0;
 414   1      }
 415          
 416          //???????,1??,0??/////////////////////////////////////////////////////////////////////////////////////////
             -/////////
 417          void spray_control(u16 input)
 418          {
 419   1          SPRAY=input;
 420   1      }
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 8   

 421          
 422          //???????,1??,0??/////////////////////////////////////////////////////////////////////////////////////////
             -/////////
 423          void light_control(u16 input)
 424          {
 425   1          LIGHT=input;
 426   1      }
 427          
 428          //?????????
 429          /*******************************************************************************
 430          * ? ? ?         : ds18b20_reset
 431          * ????       : ??DS18B20  
 432          * ?    ?         : ?
 433          * ?    ?         : ?
 434          *******************************************************************************/
 435          void ds18b20_reset(void)
 436          {
 437   1        TEMPATURE=0;  //??DQ
 438   1        delay_10us(75); //??750us
 439   1        TEMPATURE=1;  //DQ=1
 440   1        delay_10us(2);  //20US
 441   1      }
 442          
 443          /*******************************************************************************
 444          * ? ? ?         : ds18b20_check
 445          * ????       : ??DS18B20????
 446          * ?    ?         : ?
 447          * ?    ?         : 1:????DS18B20???,0:??
 448          *******************************************************************************/
 449          u8 ds18b20_check(void)
 450          {
 451   1        u8 time_temp=0;
 452   1      
 453   1        while(TEMPATURE&&time_temp<20)  //??DQ????
 454   1        {
 455   2          time_temp++;
 456   2          delay_10us(1);  
 457   2        }
 458   1        if(time_temp>=20)return 1;  //?????????1
 459   1        else time_temp=0;
 460   1        while((!TEMPATURE)&&time_temp<20) //??DQ????
 461   1        {
 462   2          time_temp++;
 463   2          delay_10us(1);
 464   2        }
 465   1        if(time_temp>=20)return 1;  //?????????1
 466   1        return 0;
 467   1      }
 468          
 469          /*******************************************************************************
 470          * ? ? ?         : ds18b20_read_bit
 471          * ????       : ?DS18B20?????
 472          * ?    ?         : ?
 473          * ?    ?         : 1/0
 474          *******************************************************************************/
 475          u8 ds18b20_read_bit(void)
 476          {
 477   1        u8 dat=0;
 478   1        
 479   1        TEMPATURE=0;
 480   1        _nop_();_nop_();
 481   1        TEMPATURE=1;  
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 9   

 482   1        _nop_();_nop_(); //????????,???15us?????
 483   1        if(TEMPATURE)dat=1; //??????1???dat?1,???0
 484   1        else dat=0;
 485   1        delay_10us(5);
 486   1        return dat;
 487   1      } 
 488          
 489          /*******************************************************************************
 490          * ? ? ?         : ds18b20_read_byte
 491          * ????       : ?DS18B20??????
 492          * ?    ?         : ?
 493          * ?    ?         : ??????
 494          *******************************************************************************/
 495          u8 ds18b20_read_byte(void)
 496          {
 497   1        u8 i=0;
 498   1        u8 dat=0;
 499   1        u8 temp=0;
 500   1      
 501   1        for(i=0;i<8;i++)//??8?,??????,?????????
 502   1        {
 503   2          temp=ds18b20_read_bit();
 504   2          dat=(temp<<7)|(dat>>1);
 505   2        }
 506   1        return dat; 
 507   1      }
 508          
 509          /*******************************************************************************
 510          * ? ? ?         : ds18b20_write_byte
 511          * ????       : ??????DS18B20
 512          * ?    ?         : dat:??????
 513          * ?    ?         : ?
 514          *******************************************************************************/
 515          void ds18b20_write_byte(u8 dat)
 516          {
 517   1        u8 i=0;
 518   1        u8 temp=0;
 519   1      
 520   1        for(i=0;i<8;i++)//??8?,?????,?????????
 521   1        {
 522   2          temp=dat&0x01;//????????
 523   2          dat>>=1;//????????
 524   2          if(temp)
 525   2          {
 526   3            TEMPATURE=0;
 527   3            _nop_();_nop_();
 528   3            TEMPATURE=1;  
 529   3            delay_10us(6);
 530   3          }
 531   2          else
 532   2          {
 533   3            TEMPATURE=0;
 534   3            delay_10us(6);
 535   3            TEMPATURE=1;
 536   3            _nop_();_nop_();  
 537   3          } 
 538   2        } 
 539   1      }
 540          
 541          /*******************************************************************************
 542          * ? ? ?         : ds18b20_start
 543          * ????       : ??????
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 10  

 544          * ?    ?         : ?
 545          * ?    ?         : ?
 546          *******************************************************************************/
 547          void ds18b20_start(void)
 548          {
 549   1        ds18b20_reset();//??
 550   1        ds18b20_check();//??DS18B20
 551   1        ds18b20_write_byte(0xcc);//SKIP ROM
 552   1          ds18b20_write_byte(0x44);//???? 
 553   1      }
 554          
 555          /*******************************************************************************
 556          * ? ? ?         : ds18b20_init
 557          * ????       : ???DS18B20?IO? DQ ????DS???
 558          * ?    ?         : ?
 559          * ?    ?         : 1:???,0:??
 560          *******************************************************************************///////////////////////////
             -///////////////////////
 561          u8 ds18b20_init(void)
 562          {
 563   1        ds18b20_reset();
 564   1        return ds18b20_check(); 
 565   1      }
 566          
 567          /*******************************************************************************
 568          * ? ? ?         : ds18b20_read_temperture
 569          * ????       : ?ds18b20?????
 570          * ?    ?         : ?
 571          * ?    ?         : ????
 572          *******************************************************************************///////////////////////////
             -///////////////////////
 573          float temperature_read(void)
 574          {
 575   1        float temp;
 576   1        u8 dath=0;
 577   1        u8 datl=0;
 578   1        u16 value=0;
 579   1      
 580   1        ds18b20_start();//????
 581   1        ds18b20_reset();//??
 582   1        ds18b20_check();
 583   1        ds18b20_write_byte(0xcc);//SKIP ROM
 584   1          ds18b20_write_byte(0xbe);//????
 585   1      
 586   1        datl=ds18b20_read_byte();//???
 587   1        dath=ds18b20_read_byte();//???
 588   1        value=(dath<<8)+datl;//???16???
 589   1      
 590   1        if((value&0xf800)==0xf800)//?????,???
 591   1        {
 592   2          value=(~value)+1; //??????1
 593   2          temp=value*(-0.0625);//???? 
 594   2        }
 595   1        else //???
 596   1        {
 597   2          temp=value*0.0625;  
 598   2        }
 599   1        return temp;
 600   1      }
 601          
 602          //???????????
 603          //??DHT11
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 11  

 604          void DHT11_Rst(void)     
 605          {                 
 606   1        MOISTURE_AIR=1;
 607   1        delay_10us(1);
 608   1        MOISTURE_AIR=0;   //??DQ
 609   1          delay_ms(25);   //????18ms
 610   1          MOISTURE_AIR=1;   //DQ=1 
 611   1        delay_10us(3);  //????20~40us
 612   1      }
 613          //??DHT11???
 614          //??1:????DHT11???
 615          //??0:??
 616          u8 DHT11_Check(void)     
 617          {   
 618   1        u8 retry=0;
 619   1        
 620   1        while (!MOISTURE_AIR&&retry<100)//?????? 80us ????????????
 621   1        {
 622   2          retry++;
 623   2          _nop_();
 624   2        };
 625   1        if(retry>=100)return 1;
 626   1        else retry=0;
 627   1          while (MOISTURE_AIR&&retry<100)//?????? 80us ?????????H??????????????
 628   1        {
 629   2          retry++;
 630   2          _nop_();
 631   2        };   
 632   1        if(retry>=100)return 1;     
 633   1        return 0;
 634   1      }
 635          
 636          
 637          //DHT11??? ///////////////////////////////////////////////////////////////////////////////////////////////
             -///
 638          //??0:?????,1:??
 639          u8 DHT11_Init(void)
 640          {
 641   1        MOISTURE_AIR=1;
 642   1        DHT11_Rst();    
 643   1        return DHT11_Check(); 
 644   1      }
 645          
 646          //?DHT11??????
 647          //???:?????
 648          u8 DHT11_Read_Byte(void)    
 649          {        
 650   1          u8 i,temp;
 651   1        u8 data_byte=0; 
 652   1        u8 retry=0;
 653   1      
 654   1          for(i=0;i<8;i++)//??8bit??? 
 655   1          { 
 656   2      //    while(!MOISTURE_AIR);//??50us??????????
 657   2          while (!MOISTURE_AIR&&retry<50)//??50us??????????
 658   2          {
 659   3            retry++;
 660   3            _nop_();
 661   3          };
 662   2          retry=0; 
 663   2          delay_10us(3);//??40us 
 664   2          temp=0;//???26us-28us?1????????'0' 
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 12  

 665   2          if(MOISTURE_AIR==1) 
 666   2            temp=1; //??26us-28us???;??????T?????????'1' 
 667   2      //    while(MOISTURE_AIR);//???????????'0'?26us-28us??'1'?70us
 668   2          while (MOISTURE_AIR&&retry<100)//???????????'0'?26us-28us??'1'?70us
 669   2          {
 670   3            retry++;
 671   3            _nop_();
 672   3          };
 673   2          data_byte<<=1;//??????????????? 
 674   2          data_byte|=temp; 
 675   2          } 
 676   1      
 677   1          return data_byte;
 678   1      }
 679          
 680          //?DHT11??????////////////////////////////////////////////////////////////////////////////////////////////
             -//////
 681          //temp:???(??:0~50°)
 682          //humi:???(??:20%~90%)
 683          //???:0,??;1,????
 684          u8 air_moisture_read(u8 *temp,u8 *humi)    
 685          {        
 686   1        u8 buf[5];
 687   1        u8 i;
 688   1        DHT11_Rst();
 689   1        if(DHT11_Check()==0)
 690   1        {
 691   2          for(i=0;i<5;i++)//??40???
 692   2          {
 693   3            buf[i]=DHT11_Read_Byte();
 694   3          }
 695   2          if((buf[0]+buf[1]+buf[2]+buf[3])==buf[4])
 696   2          {
 697   3            *humi=buf[0];
 698   3            *temp=buf[2];
 699   3          }
 700   2          
 701   2        }else return 1;
 702   1        return 0;     
 703   1      }
 704          
 705          
 706          
 707          
 708          
 709          
 710          
 711          
 712          
 713          
 714          
 715          
 716          
 717          
 718          
 719          
 720          
 721          
 722          
 723          
 724          
 725          
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 13  

 726          
 727          
 728          
 729          
 730          
 731          
 732          
 733          
 734          
 735          
 736          
 737          
 738          
 739          
 740          
 741          
 742          
 743          
 744          
 745          
 746          
 747          
 748          
 749          
 750          u8 keytmp=0;
 751          u8 key=0;
 752          //?????
 753          u16 stay_time;
 754          int temp_value;
 755          u8 tempbuf[8];
 756          
 757          //???????
 758          u8 temp=0;
 759          u8 humi=0;
 760          u8 i=0;
 761          u8 temp_buf2[3],humi_buf[3];
 762          u8 gsmg_code[17]={0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,
 763                  0x7f,0x6f,0x77,0x7c,0x39,0x5e,0x79,0x71};
 764          
 765          //?????
 766          u16 adc_light_value=0;
 767          u8 adc_light_buf[4];
 768                  
 769          //
 770          u16 adc_water_level_value=0;
 771          u8 adc_water_level_buf[4];
 772                  
 773                  
 774          void main()
 775          {
 776   1        lcd1602_init();
 777   1        lcd1602_show_string(0,0,"Self-testing");
 778   1        stay_time=0;
 779   1        ds18b20_init();
 780   1        DHT11_Init();
 781   1        spray_control(0);
 782   1        light_control(0);
 783   1        pump_control(500);
 784   1        lcd1602_show_string(0,0,"Self-test");
 785   1        lcd1602_show_string(0,1,"Success!!!");
 786   1        while(1)
 787   1        {
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 14  

 788   2          key=key_matrix_flip_scan();   
 789   2          stay_time++;
 790   2           if(stay_time==22000){
 791   3             
 792   3            temp_value=temperature_read()*10;//DS18B20
 793   3            if(temp_value<0)
 794   3            {
 795   4              temp_value=-temp_value;
 796   4              tempbuf[0]='-'; 
 797   4            }
 798   3            else
 799   3              tempbuf[0]=' ';
 800   3            if(temp_value>=1000)
 801   3              tempbuf[1]=temp_value/1000+0x30;
 802   3            else
 803   3              tempbuf[1]=' ';
 804   3            tempbuf[2]=temp_value%1000/100+0x30;
 805   3            tempbuf[3]=temp_value%1000%100/10+0x30;
 806   3            tempbuf[4]='.';
 807   3            tempbuf[5]=temp_value%1000%100%10+0x30;
 808   3            tempbuf[6]='C';
 809   3            tempbuf[7]='\0';  
 810   3                
 811   3            adc_light_value=xpt2046_read_adc_value(0xA4);//????
 812   3            adc_light_buf[0]=adc_light_value%1000/100+0x30;
 813   3            adc_light_buf[1]=adc_light_value%1000%100/10+0x30;
 814   3            adc_light_buf[2]=adc_light_value%1000%100%10+0x30;
 815   3            adc_light_buf[3]='\0';
 816   3              
 817   3            adc_water_level_value=xpt2046_read_adc_value(0xE4);//?????
 818   3            adc_water_level_buf[0]=adc_water_level_value%1000/100+0x30;
 819   3            adc_water_level_buf[1]=adc_water_level_value%1000%100/10+0x30;
 820   3            adc_water_level_buf[2]=adc_water_level_value%1000%100%10+0x30;
 821   3            adc_water_level_buf[3]='\0';      
 822   3           
 823   3            air_moisture_read(&temp,&humi);//DHT11
 824   3            temp_buf2[0]=temp/10+0x30;  
 825   3            temp_buf2[1]=temp%10+0x30;
 826   3            temp_buf2[2]='\0';
 827   3      
 828   3            humi_buf[0]=humi/10+0x30; 
 829   3            humi_buf[1]=humi%10+0x30;
 830   3            humi_buf[2]='\0';
 831   3            
 832   3            stay_time=0;
 833   3          }
 834   2           
 835   2      
 836   2      
 837   2          
 838   2          // keytmp=key_matrix_flip_scan();
 839   2          // if((key==1||key==2||key==3||key==4||key==5)&&keytmp==0)
 840   2          // { }
 841   2          // else
 842   2          //  key=keytmp;
 843   2          switch(key)
 844   2          {
 845   3            case(1):{
 846   4              lcd1602_init();
 847   4              lcd1602_show_string(0,0,"Temperature:");//?????
 848   4              lcd1602_show_string(0,1,tempbuf);//?????
 849   4              break;  
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 15  

 850   4            }
 851   3            case(2):{
 852   4              lcd1602_init();
 853   4              lcd1602_show_string(0,0,"Soil Moisture:");//?????
 854   4              lcd1602_show_string(0,1,"N/A");//?????
 855   4              break;  
 856   4            }
 857   3            case(3):{
 858   4              lcd1602_init();
 859   4              lcd1602_show_string(0,0,"Water Level:");//?????
 860   4              lcd1602_show_string(0,1,adc_water_level_buf);//?????
 861   4              break;  
 862   4            }
 863   3            case(4):{
 864   4              lcd1602_init();
 865   4              lcd1602_show_string(0,0,"Air Moisture:");//?????
 866   4              lcd1602_show_string(0,1,humi_buf);//?????
 867   4              break;  
 868   4            }
 869   3            case(5):{
 870   4              lcd1602_init();
 871   4              lcd1602_show_string(0,0,"Light Intensity:");//?????
 872   4              lcd1602_show_string(0,1,adc_light_buf);//?????
 873   4              break;  
 874   4            }
 875   3            case(6):{
 876   4              lcd1602_init();
 877   4              lcd1602_show_string(0,0,"Shield Rising");
 878   4              step_motor_control(1);
 879   4              lcd1602_init();
 880   4              lcd1602_show_string(0,0,"Shield Rised");
 881   4              break;  
 882   4            }
 883   3            case(7):{
 884   4              lcd1602_init();
 885   4              lcd1602_show_string(0,0,"Shield Falling");
 886   4              step_motor_control(0);
 887   4              lcd1602_init();
 888   4              lcd1602_show_string(0,0,"Shield Falled");
 889   4              break;  
 890   4            }
 891   3            case(8):{
 892   4              lcd1602_init();
 893   4              lcd1602_show_string(0,0,"Pump Working");
 894   4              pump_control(5000);
 895   4              lcd1602_show_string(0,0,"Pump Worked 5s");
 896   4              break;  
 897   4            }
 898   3            case(9):{
 899   4              lcd1602_init();
 900   4              lcd1602_show_string(0,0,"Spray Work Begin");
 901   4              spray_control(1);
 902   4              break;  
 903   4            }
 904   3            case(10):{
 905   4              lcd1602_init();
 906   4              lcd1602_show_string(0,0,"Spray Work Stop");
 907   4              spray_control(0);
 908   4              break;  
 909   4            }
 910   3            case(11):{
 911   4              lcd1602_init();
C51 COMPILER V9.60.7.0   MAIN                                                              12/23/2024 16:36:52 PAGE 16  

 912   4              lcd1602_show_string(0,0,"LED Work Begin");
 913   4              light_control(1);
 914   4              break;  
 915   4            }
 916   3            case(12):{
 917   4              lcd1602_init();
 918   4              lcd1602_show_string(0,0,"LED Work Stop");
 919   4              light_control(0);
 920   4              break;  
 921   4            }
 922   3            case(13):{
 923   4              lcd1602_init();
 924   4              lcd1602_show_string(0,0,"Self-testing");
 925   4              stay_time=0;
 926   4              ds18b20_init();
 927   4              DHT11_Init();
 928   4              spray_control(0);
 929   4              light_control(0);
 930   4              pump_control(500);
 931   4              lcd1602_show_string(0,0,"Self-test");
 932   4              lcd1602_show_string(0,1,"Success!!!");
 933   4              break;  
 934   4            }
 935   3            case(14):{
 936   4              break;  
 937   4            }
 938   3            case(15):{
 939   4              break;  
 940   4            }
 941   3            case(16):{
 942   4              break;  
 943   4            }
 944   3            default:{
 945   4              break;
 946   4            }
 947   3          }
 948   2        }
 949   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2156    ----
   CONSTANT SIZE    =    256    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     55      28
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
