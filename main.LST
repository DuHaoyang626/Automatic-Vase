C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Program Files\keil_v5\C51_961\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND
                    - TABS(2)

line level    source

   1          #include"reg52.h"
   2          #include "intrins.h"
   3          
   4          
   5          //????
   6          typedef unsigned int u16;
   7          typedef unsigned char u8;
   8          
   9          
  10          //????
  11          
  12          #define LCD1602_DATAPORT P0//LCD????P0^0-P0^3
  13          sbit cs = P0^4;//????,?????
  14          sbit clk = P0^5;//??????
  15          sbit dio = P0^6;//????DI???DO
  16          sbit WIFI_IO=P0^7;//??WiFi???P0^7
  17          
  18          #define KEY_MATRIX_PORT P1//???????
  19          
  20          sbit PUMP=P2^0;//????P2^0
  21          sbit SPRAY=P2^1;//?????2^1
  22          sbit LIGHT=P2^2;//LED?????P2^2
  23          sbit MOISTURE_AIR=P2^3;//?????????P2^3
  24          sbit TEMPATURE=P2^4;//???????P2^4
  25          sbit LCD1602_RW=P2^5;//LCD????
  26          sbit LCD1602_RS=P2^6;//LCD??????
  27          sbit LCD1602_E=P2^7; //LCD????
  28          
  29          sbit STEPMOTOR1=P3^0;//????1??P3^0
  30          sbit STEPMOTOR2=P3^1;//????2??P3^1
  31          sbit STEPMOTOR3=P3^2;//????3??P3^2
  32          sbit STEPMOTOR4=P3^3;//????4??P3^3
  33          sbit DIN  = P3^4;   //??ADC??
  34          sbit CS   = P3^5;   //??ADC??
  35          sbit CLK  = P3^6;   //??ADC??
  36          sbit DOUT = P3^7;   //??ADC??
  37          
  38          //????
  39          
  40          //LCD1602???4??8???,??1,??LCD1602???????,???8?
  41          #define LCD1602_4OR8_DATA_INTERFACE 1 //????4????LCD1602
  42          
  43          // ????????,???,????
  44          #define STEPMOTOR_MAXSPEED        100//????????,????1
  45          #define STEPMOTOR_MINSPEED        350//????????
  46          #define STEPMOTOR_SHIELD_HIGHT    10//?????
  47          #define STEPMOTOR_SHIELD_RANGE    300//?????????
  48          
  49          //????
  50          //????????
  51          u16 stay_time;
  52          
  53          //???????
  54          u16 temp_value;
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 2   

  55          u8 temp_buf[8];
  56          
  57          //?????????
  58          u16 soil_moisture;
  59          u8 soil_moisture_buf[4];
  60          
  61          //???????
  62          u16 water_lavel;
  63          u8 water_lavel_buf[4];
  64          
  65          //?????????
  66          u8 temp=0;
  67          u8 humi=0;
  68          u8 i=0;
  69          u8 temp_buf2[3],humi_buf[3];
  70          
  71          //???????
  72          u16 light_intensity=0;
  73          u8 light_intensity_buf[4];
  74                  
  75          //???????????,0?????,1?????
  76          u16 StepMotor_status=0;
  77          
  78          //??????
  79          u8 key=0;
  80          
  81          
  82          //????
  83          
  84          //??2us
  85          void Delay_2us(void)
  86          {
  87   1        _nop_();
  88   1        _nop_();
  89   1      }
  90          
  91          //????,??int x,??x/100??
  92          void delay_10us(u16 ten_us){
  93   1      while(ten_us--);
  94   1      }
  95          
  96          //????,??int x,??x??
  97          void delay_ms(u16 ms)
  98          {
  99   1        u16 i,j;
 100   1        for(i=ms;i>0;i--)
 101   1          for(j=110;j>0;j--);
 102   1      }
 103          
 104          //????????
 105          
 106          //??ADC2046??
 107          /*******************************************************************************
 108          * ? ? ?       : xpt2046_wirte_data
 109          * ????     : XPT2046???
 110          * ?    ?       : dat:?????
 111          * ?    ?       : ?
 112          *******************************************************************************/
 113          void xpt2046_wirte_data(u8 dat)
 114          {
 115   1        u8 i;
 116   1      
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 3   

 117   1        CLK = 0;
 118   1        _nop_();
 119   1        for(i=0;i<8;i++)//??8?,??????,?????
 120   1        {
 121   2          DIN = dat >> 7;//????????
 122   2          dat <<= 1;//???????
 123   2          CLK = 0;//CLK???????????,??????
 124   2          _nop_();  
 125   2          CLK = 1;
 126   2          _nop_();
 127   2        }
 128   1      }
 129          
 130          /*******************************************************************************
 131          * ? ? ?       : xpt2046_read_data
 132          * ????     : XPT2046???
 133          * ?    ?       : ?
 134          * ?    ?       : XPT2046??12???
 135          *******************************************************************************/
 136          u16 xpt2046_read_data(void)
 137          {
 138   1        u8 i;
 139   1        u16 dat=0;
 140   1      
 141   1        CLK = 0;
 142   1        _nop_();
 143   1        for(i=0;i<12;i++)//??12?,??????,???????,????????u16
 144   1        {
 145   2          dat <<= 1;
 146   2          CLK = 1;
 147   2          _nop_();
 148   2          CLK = 0; //CLK???????????,??????
 149   2          _nop_();
 150   2          dat |= DOUT;//?????,??????  
 151   2        }
 152   1        return dat; 
 153   1      }
 154          
 155          /*******************************************************************************
 156          * ? ? ?       : xpt2046_read_adc_value
 157          * ????     : XPT2046?AD??
 158          * ?    ?       : cmd:??
 159          * ?    ?       : XPT2046??AD?
 160          *******************************************************************************///////////////////////////
             -///////////////////////
 161          u16 xpt2046_read_adc_value(u8 cmd)
 162          {
 163   1        u8 i;
 164   1        u16 adc_value=0;
 165   1      
 166   1        CLK = 0;//?????
 167   1        CS  = 0;//??XPT2046
 168   1        xpt2046_wirte_data(cmd);//?????
 169   1        for(i=6; i>0; i--);//????????
 170   1        CLK = 1;
 171   1        _nop_();
 172   1        CLK = 0;//??????,??BUSY
 173   1        _nop_();
 174   1        adc_value=xpt2046_read_data();
 175   1        CS = 1;//??XPT2046
 176   1        return adc_value;
 177   1      }
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 4   

 178          
 179          //??ADC0832
 180          /*****************************************
 181          ????:??ADC0832??
 182          ????:ADC_read_data(bit channel)
 183          ????:ch?????,ch=0????0,ch=1????1
 184          ????:?????????ADC??,???unsigned char
 185                ?????0?,??????
 186          ******************************************/
 187          u8 ADC_read_data(bit channel)
 188          {
 189   1        u8 i,dat0=0,dat1=0;
 190   1        //------?1??????di??,????---------
 191   1      
 192   1        cs=0;     //??????,??AD????
 193   1        clk=0;      //?????
 194   1        
 195   1        dio=1;      //????????
 196   1        Delay_2us();
 197   1        clk=1;      //???????,??????,??????(DI=1)
 198   1        Delay_2us();
 199   1          clk=0;      //?1??????
 200   1        dio=1;
 201   1        Delay_2us();
 202   1        
 203   1        clk=1;        // ?2??????DI=1,??????????
 204   1        Delay_2us();   
 205   1        //------??2????,??????????(1:????,0:??????)---------    
 206   1        clk=0;  
 207   1        dio=channel;         // ?3????,??DI,????;
 208   1        Delay_2us();
 209   1        clk=1;
 210   1        Delay_2us();
 211   1      
 212   1         //------??3????,??????????(1:??CH1,0:??CH0)------------  
 213   1        
 214   1        clk=0;
 215   1        dio=1;          //????????,DI??,????? 
 216   1        Delay_2us();  
 217   1        for(i=0;i<8;i++)                 //?4~11?8???????(MSB->LSB)
 218   1        {
 219   2          clk=1;
 220   2          Delay_2us();
 221   2          clk=0;
 222   2          Delay_2us();
 223   2          dat0=dat0<<1|dio;
 224   2        }
 225   1        for(i=0;i<8;i++)                 //?11~18?8???????(LSB->MSB)
 226   1        {
 227   2          dat1=dat1|((u8)(dio)<<i);
 228   2          clk=1;
 229   2          Delay_2us();
 230   2          clk=0;
 231   2          Delay_2us();
 232   2        } 
 233   1        cs=1;         
 234   1        return (dat0==dat1)?dat0:0;     //??dat0?dat1????
 235   1      }
 236          
 237          //LCD????
 238          /*******************************************************************************
 239          * ? ? ?       : lcd1602_write_cmd
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 5   

 240          * ????     : LCD1602???
 241          * ?    ?       : cmd:??
 242          * ?    ?       : ?
 243          *******************************************************************************/
 244          #if (LCD1602_4OR8_DATA_INTERFACE==0)//8?LCD
              void lcd1602_write_cmd(u8 cmd)
              {
                LCD1602_RS=0;//????
                LCD1602_RW=0;//???
                LCD1602_E=0;
                LCD1602_DATAPORT=cmd;//????
                delay_ms(1);
                LCD1602_E=1;//???E??????
                delay_ms(1);
                LCD1602_E=0;//???E????????  
              }
              #else //4?LCD
 257          void lcd1602_write_cmd(u8 cmd)
 258          {
 259   1        LCD1602_RS=0;//????
 260   1        LCD1602_RW=0;//???
 261   1        LCD1602_E=0;
 262   1        LCD1602_DATAPORT=cmd;//????
 263   1        delay_ms(1);
 264   1        LCD1602_E=1;//???E??????
 265   1        delay_ms(1);
 266   1        LCD1602_E=0;//???E????????
 267   1        
 268   1        LCD1602_DATAPORT=cmd<<4;//????
 269   1        delay_ms(1);
 270   1        LCD1602_E=1;//???E??????
 271   1        delay_ms(1);
 272   1        LCD1602_E=0;//???E????????  
 273   1      }
 274          #endif
 275          
 276          /*******************************************************************************
 277          * ? ? ?       : lcd1602_write_data
 278          * ????     : LCD1602???
 279          * ?    ?       : dat:??
 280          * ?    ?       : ?
 281          *******************************************************************************/
 282          #if (LCD1602_4OR8_DATA_INTERFACE==0)//8?LCD
              void lcd1602_write_data(u8 dat) 
              {
                LCD1602_RS=1;//????
                LCD1602_RW=0;//???
                LCD1602_E=0;
                LCD1602_DATAPORT=dat;//????
                delay_ms(1);
                LCD1602_E=1;//???E??????
                delay_ms(1);
                LCD1602_E=0;//???E????????    
              }
              #else
 295          void lcd1602_write_data(u8 dat) 
 296          {
 297   1        LCD1602_RS=1;//????
 298   1        LCD1602_RW=0;//???
 299   1        LCD1602_E=0;
 300   1        LCD1602_DATAPORT=dat;//????
 301   1        delay_ms(1);
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 6   

 302   1        LCD1602_E=1;//???E??????
 303   1        delay_ms(1);
 304   1        LCD1602_E=0;//???E????????
 305   1        
 306   1        LCD1602_DATAPORT=dat<<4;//????
 307   1        delay_ms(1);
 308   1        LCD1602_E=1;//???E??????
 309   1        delay_ms(1);
 310   1        LCD1602_E=0;//???E????????    
 311   1      }
 312          #endif
 313          
 314          /*******************************************************************************
 315          * ? ? ?       : lcd1602_init
 316          * ????     : LCD1602???
 317          * ?    ?       : ?
 318          * ?    ?       : ?
 319          *******************************************************************************///////////////////////////
             -///////////////////////
 320          #if (LCD1602_4OR8_DATA_INTERFACE==0)//8?LCD
              void lcd1602_init(void)
              {
                lcd1602_write_cmd(0x38);//????8?,??2?,5*7??/??
                lcd1602_write_cmd(0x0c);//?????,???,????
                lcd1602_write_cmd(0x06);//??????????,??????
                lcd1602_write_cmd(0x01);//??  
              }
              #else
 329          void lcd1602_init(void)
 330          {
 331   1        lcd1602_write_cmd(0x28);//????4?,??2?,5*7??/??
 332   1        lcd1602_write_cmd(0x0c);//?????,???,????
 333   1        lcd1602_write_cmd(0x06);//??????????,??????
 334   1        lcd1602_write_cmd(0x01);//??  
 335   1      }
 336          #endif
 337          
 338          /*******************************************************************************
 339          * ? ? ?       : lcd1602_clear
 340          * ????     : LCD1602??
 341          * ?    ?       : ?
 342          * ?    ?       : ?
 343          *******************************************************************************/
 344          void lcd1602_clear(void)
 345          {
 346   1        lcd1602_write_cmd(0x01);  
 347   1      }
 348          
 349          /*******************************************************************************
 350          * ? ? ?       : lcd1602_show_string
 351          * ????     : LCD1602????
 352          * ?    ?       : x,y:????,x=0~15,y=0~1;
 353                     str:?????
 354          * ?    ?       : ?
 355          *******************************************************************************///////////////////////////
             -///////////////////////
 356          void lcd1602_show_string(u8 x,u8 y,u8 *str)
 357          {
 358   1        u8 i=0;
 359   1      
 360   1        if(y>1||x>15)return;//???????????
 361   1      
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 7   

 362   1        if(y<1) //?1???
 363   1        { 
 364   2          while(*str!='\0')//?????'\0'??,??????????
 365   2          {
 366   3            if(i<16-x)//???????????????,?????????
 367   3            {
 368   4              lcd1602_write_cmd(0x80+i+x);//????????? 
 369   4            }
 370   3            else
 371   3            {
 372   4              lcd1602_write_cmd(0x40+0x80+i+x-16);//????????? 
 373   4            }
 374   3            lcd1602_write_data(*str);//????
 375   3            str++;//????
 376   3            i++;  
 377   3          } 
 378   2        }
 379   1        else  //?2???
 380   1        {
 381   2          while(*str!='\0')
 382   2          {
 383   3            if(i<16-x) //???????????????,?????????
 384   3            {
 385   4              lcd1602_write_cmd(0x80+0x40+i+x); 
 386   4            }
 387   3            else
 388   3            {
 389   4              lcd1602_write_cmd(0x80+i+x-16); 
 390   4            }
 391   3            lcd1602_write_data(*str);
 392   3            str++;
 393   3            i++;  
 394   3          } 
 395   2        }       
 396   1      }
 397          
 398          //??????
 399          /*******************************************************************************
 400          * ? ? ?       : key_matrix_flip_scan
 401          * ????     : ?????????,??????????,?????????
 402          * ?    ?       : ?
 403          * ?    ?       : key_value:1-16,??S1-S16?,
 404                     0:?????
 405          *******************************************************************************///////////////////////////
             -///////////////////////
 406          u8 key_matrix_flip_scan(void)
 407          {
 408   1        static u8 key_value=0;
 409   1      
 410   1        KEY_MATRIX_PORT=0x0f;//??????0,???1
 411   1        if(KEY_MATRIX_PORT!=0x0f)//????????
 412   1        {
 413   2          delay_10us(1000);//??
 414   2          if(KEY_MATRIX_PORT!=0x0f)
 415   2          {
 416   3            //???
 417   3            KEY_MATRIX_PORT=0x0f;
 418   3            switch(KEY_MATRIX_PORT)//????0,???????? 
 419   3            {
 420   4              case 0x07: key_value=1;break;
 421   4              case 0x0b: key_value=2;break;
 422   4              case 0x0d: key_value=3;break;
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 8   

 423   4              case 0x0e: key_value=4;break;
 424   4            }
 425   3            //???
 426   3            KEY_MATRIX_PORT=0xf0;
 427   3            switch(KEY_MATRIX_PORT)//????0,???????? 
 428   3            {
 429   4              case 0x70: key_value=key_value;break;
 430   4              case 0xb0: key_value=key_value+4;break;
 431   4              case 0xd0: key_value=key_value+8;break;
 432   4              case 0xe0: key_value=key_value+12;break;
 433   4            }
 434   3            while(KEY_MATRIX_PORT!=0xf0);//?????? 
 435   3          }
 436   2        }
 437   1        else
 438   1          key_value=0;    
 439   1        
 440   1        return key_value;   
 441   1      }
 442          
 443          //????????
 444          /*******************************************************************************
 445          * ? ? ?       : step_motor_28BYJ48_send_pulse
 446          * ????     : ???????ULN2003???????????????
 447          * ?    ?       : step:??????,???0~7
 448                     dir:????,1:???,0:???
 449          * ?    ?       : ?
 450          *******************************************************************************/
 451          void step_motor_28BYJ48_send_pulse(u8 step,u8 dir)
 452          {
 453   1        u8 temp=step;
 454   1        
 455   1        if(dir==0)  //????????
 456   1          temp=7-step;//??????
 457   1        switch(temp)//8?????:A->AB->B->BC->C->CD->D->DA
 458   1        {
 459   2          case 0: STEPMOTOR1=1;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=0;break;
 460   2          case 1: STEPMOTOR1=1;STEPMOTOR2=1;STEPMOTOR3=0;STEPMOTOR4=0;break;
 461   2          case 2: STEPMOTOR1=0;STEPMOTOR2=1;STEPMOTOR3=0;STEPMOTOR4=0;break;
 462   2          case 3: STEPMOTOR1=0;STEPMOTOR2=1;STEPMOTOR3=1;STEPMOTOR4=0;break;
 463   2          case 4: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=1;STEPMOTOR4=0;break;
 464   2          case 5: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=1;STEPMOTOR4=1;break;
 465   2          case 6: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=1;break;
 466   2          case 7: STEPMOTOR1=1;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=1;break;
 467   2          default: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=0;break;//???? 
 468   2        }     
 469   1      }
 470          
 471          // //????,1????,0????/////////////////////////////////////////////////////////////////////////////////////
             -/////////////
 472          // void step_motor_control(u16 input){
 473          //     if(input!=StepMotor_status)
 474          //     {
 475          //         u8 key=0;
 476          //      u8 dir=0;//???????
 477          //      u8 speed=STEPMOTOR_MAXSPEED;//????????
 478          //      u8 step=0;
 479          //         u16 time=0;
 480          //         u16 usetime=STEPMOTOR_SHIELD_HIGHT*STEPMOTOR_SHIELD_RANGE;
 481          
 482          //         if(input==1)
 483          //         {
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 9   

 484          //             while(time<=usetime){
 485          //                 step_motor_28BYJ48_send_pulse(step++,dir);
 486          //                time++;
 487          //                if(step==8)step=0;    
 488          //                delay_10us(speed);
 489          //             }
 490          //      StepMotor_status=1;
 491          //         }
 492          //         if(input==0)
 493          //         {
 494          //             dir=!dir;
 495          //             while(time<=usetime){
 496          //                 step_motor_28BYJ48_send_pulse(step++,dir);
 497          //                time++;
 498          //                if(step==8)step=0;    
 499          //                delay_10us(speed);
 500          //             }
 501          //      StepMotor_status=0;
 502          //         }
 503          //     }
 504          // }
 505          
 506          //?????????
 507          /*******************************************************************************
 508          * ? ? ?         : ds18b20_reset
 509          * ????       : ??DS18B20  
 510          * ?    ?         : ?
 511          * ?    ?         : ?
 512          *******************************************************************************/
 513          void ds18b20_reset(void)
 514          {
 515   1        TEMPATURE=0;  //??DQ
 516   1        delay_10us(75); //??750us
 517   1        TEMPATURE=1;  //DQ=1
 518   1        delay_10us(2);  //20US
 519   1      }
 520          
 521          /*******************************************************************************
 522          * ? ? ?         : ds18b20_check
 523          * ????       : ??DS18B20????
 524          * ?    ?         : ?
 525          * ?    ?         : 1:????DS18B20???,0:??
 526          *******************************************************************************/
 527          u8 ds18b20_check(void)
 528          {
 529   1        u8 time_temp=0;
 530   1      
 531   1        while(TEMPATURE&&time_temp<20)  //??DQ????
 532   1        {
 533   2          time_temp++;
 534   2          delay_10us(1);  
 535   2        }
 536   1        if(time_temp>=20)return 1;  //?????????1
 537   1        else time_temp=0;
 538   1        while((!TEMPATURE)&&time_temp<20) //??DQ????
 539   1        {
 540   2          time_temp++;
 541   2          delay_10us(1);
 542   2        }
 543   1        if(time_temp>=20)return 1;  //?????????1
 544   1        return 0;
 545   1      }
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 10  

 546          
 547          /*******************************************************************************
 548          * ? ? ?         : ds18b20_read_bit
 549          * ????       : ?DS18B20?????
 550          * ?    ?         : ?
 551          * ?    ?         : 1/0
 552          *******************************************************************************/
 553          u8 ds18b20_read_bit(void)
 554          {
 555   1        u8 dat=0;
 556   1        
 557   1        TEMPATURE=0;
 558   1        _nop_();_nop_();
 559   1        TEMPATURE=1;  
 560   1        _nop_();_nop_(); //????????,???15us?????
 561   1        if(TEMPATURE)dat=1; //??????1???dat?1,???0
 562   1        else dat=0;
 563   1        delay_10us(5);
 564   1        return dat;
 565   1      } 
 566          
 567          /*******************************************************************************
 568          * ? ? ?         : ds18b20_read_byte
 569          * ????       : ?DS18B20??????
 570          * ?    ?         : ?
 571          * ?    ?         : ??????
 572          *******************************************************************************/
 573          u8 ds18b20_read_byte(void)
 574          {
 575   1        u8 i=0;
 576   1        u8 dat=0;
 577   1        u8 temp=0;
 578   1      
 579   1        for(i=0;i<8;i++)//??8?,??????,?????????
 580   1        {
 581   2          temp=ds18b20_read_bit();
 582   2          dat=(temp<<7)|(dat>>1);
 583   2        }
 584   1        return dat; 
 585   1      }
 586          
 587          /*******************************************************************************
 588          * ? ? ?         : ds18b20_write_byte
 589          * ????       : ??????DS18B20
 590          * ?    ?         : dat:??????
 591          * ?    ?         : ?
 592          *******************************************************************************/
 593          void ds18b20_write_byte(u8 dat)
 594          {
 595   1        u8 i=0;
 596   1        u8 temp=0;
 597   1      
 598   1        for(i=0;i<8;i++)//??8?,?????,?????????
 599   1        {
 600   2          temp=dat&0x01;//????????
 601   2          dat>>=1;//????????
 602   2          if(temp)
 603   2          {
 604   3            TEMPATURE=0;
 605   3            _nop_();_nop_();
 606   3            TEMPATURE=1;  
 607   3            delay_10us(6);
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 11  

 608   3          }
 609   2          else
 610   2          {
 611   3            TEMPATURE=0;
 612   3            delay_10us(6);
 613   3            TEMPATURE=1;
 614   3            _nop_();_nop_();  
 615   3          } 
 616   2        } 
 617   1      }
 618          
 619          /*******************************************************************************
 620          * ? ? ?         : ds18b20_start
 621          * ????       : ??????
 622          * ?    ?         : ?
 623          * ?    ?         : ?
 624          *******************************************************************************/
 625          void ds18b20_start(void)
 626          {
 627   1        ds18b20_reset();//??
 628   1        ds18b20_check();//??DS18B20
 629   1        ds18b20_write_byte(0xcc);//SKIP ROM
 630   1          ds18b20_write_byte(0x44);//???? 
 631   1      }
 632          
 633          /*******************************************************************************
 634          * ? ? ?         : ds18b20_init
 635          * ????       : ???DS18B20?IO? DQ ????DS???
 636          * ?    ?         : ?
 637          * ?    ?         : 1:???,0:??
 638          *******************************************************************************///////////////////////////
             -///////////////////////
 639          u8 ds18b20_init(void)
 640          {
 641   1        ds18b20_reset();
 642   1        return ds18b20_check(); 
 643   1      }
 644          
 645          /*******************************************************************************
 646          * ? ? ?         : ds18b20_read_temperture
 647          * ????       : ?ds18b20?????
 648          * ?    ?         : ?
 649          * ?    ?         : ????
 650          *******************************************************************************///////////////////////////
             -///////////////////////
 651          // float temperature_read(void)
 652          // {
 653          //  float temp;
 654          //  u8 dath=0;
 655          //  u8 datl=0;
 656          //  u16 value=0;
 657          
 658          //  ds18b20_start();//????
 659          //  ds18b20_reset();//??
 660          //  ds18b20_check();
 661          //  ds18b20_write_byte(0xcc);//SKIP ROM
 662          //     ds18b20_write_byte(0xbe);//????
 663          
 664          //  datl=ds18b20_read_byte();//???
 665          //  dath=ds18b20_read_byte();//???
 666          //  value=(dath<<8)+datl;//???16???
 667          
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 12  

 668          //  if((value&0xf800)==0xf800)//?????,???
 669          //  {
 670          //    value=(~value)+1; //??????1
 671          //    temp=value*(-0.0625);//???? 
 672          //  }
 673          //  else //???
 674          //  {
 675          //    temp=value*0.0625;  
 676          //  }
 677          //  return temp;
 678          // }
 679          
 680          //???????????
 681          //??DHT11
 682          void DHT11_Rst(void)     
 683          {                 
 684   1        MOISTURE_AIR=1;
 685   1        delay_10us(1);
 686   1        MOISTURE_AIR=0;   //??DQ
 687   1          delay_ms(25);   //????18ms
 688   1          MOISTURE_AIR=1;   //DQ=1 
 689   1        delay_10us(3);  //????20~40us
 690   1      }
 691          //??DHT11???
 692          //??1:????DHT11???
 693          //??0:??
 694          u8 DHT11_Check(void)     
 695          {   
 696   1        u8 retry=0;
 697   1        
 698   1        while (!MOISTURE_AIR&&retry<100)//?????? 80us ????????????
 699   1        {
 700   2          retry++;
 701   2          _nop_();
 702   2        };
 703   1        if(retry>=100)return 1;
 704   1        else retry=0;
 705   1          while (MOISTURE_AIR&&retry<100)//?????? 80us ?????????H??????????????
 706   1        {
 707   2          retry++;
 708   2          _nop_();
 709   2        };   
 710   1        if(retry>=100)return 1;     
 711   1        return 0;
 712   1      }
 713          
 714          
 715          //DHT11??? ///////////////////////////////////////////////////////////////////////////////////////////////
             -///
 716          //??0:?????,1:??
 717          u8 DHT11_Init(void)
 718          {
 719   1        MOISTURE_AIR=1;
 720   1        DHT11_Rst();    
 721   1        return DHT11_Check(); 
 722   1      }
 723          
 724          //?DHT11??????
 725          //???:?????
 726          u8 DHT11_Read_Byte(void)    
 727          {        
 728   1          u8 i,temp;
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 13  

 729   1        u8 data_byte=0; 
 730   1        u8 retry=0;
 731   1      
 732   1          for(i=0;i<8;i++)//??8bit??? 
 733   1          { 
 734   2      //    while(!MOISTURE_AIR);//??50us??????????
 735   2          while (!MOISTURE_AIR&&retry<50)//??50us??????????
 736   2          {
 737   3            retry++;
 738   3            _nop_();
 739   3          };
 740   2          retry=0; 
 741   2          delay_10us(3);//??40us 
 742   2          temp=0;//???26us-28us?1????????'0' 
 743   2          if(MOISTURE_AIR==1) 
 744   2            temp=1; //??26us-28us???;??????T?????????'1' 
 745   2      //    while(MOISTURE_AIR);//???????????'0'?26us-28us??'1'?70us
 746   2          while (MOISTURE_AIR&&retry<100)//???????????'0'?26us-28us??'1'?70us
 747   2          {
 748   3            retry++;
 749   3            _nop_();
 750   3          };
 751   2          data_byte<<=1;//??????????????? 
 752   2          data_byte|=temp; 
 753   2          } 
 754   1      
 755   1          return data_byte;
 756   1      }
 757          
 758          // //?DHT11??????/////////////////////////////////////////////////////////////////////////////////////////
             -/////////
 759          // //temp:???(??:0~50°)
 760          // //humi:???(??:20%~90%)
 761          // //???:0,??;1,????
 762          // u8 air_moisture_read(u8 *temp,u8 *humi)    
 763          // {        
 764          //    u8 buf[5];
 765          //  u8 i;
 766          //  DHT11_Rst();
 767          //  if(DHT11_Check()==0)
 768          //  {
 769          //    for(i=0;i<5;i++)//??40???
 770          //    {
 771          //      buf[i]=DHT11_Read_Byte();
 772          //    }
 773          //    if((buf[0]+buf[1]+buf[2]+buf[3])==buf[4])
 774          //    {
 775          //      *humi=buf[0];
 776          //      *temp=buf[2];
 777          //    }
 778              
 779          //  }else return 1;
 780          //  return 0;     
 781          // }
 782          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 783          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 784          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 785          
 786          //????
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 14  

 787          float temperature_read(void)
 788          {
 789   1        float temp;
 790   1        u8 dath=0;
 791   1        u8 datl=0;
 792   1        u16 value=0;
 793   1      
 794   1        ds18b20_start();//????
 795   1        ds18b20_reset();//??
 796   1        ds18b20_check();
 797   1        ds18b20_write_byte(0xcc);//SKIP ROM
 798   1          ds18b20_write_byte(0xbe);//????
 799   1      
 800   1        datl=ds18b20_read_byte();//???
 801   1        dath=ds18b20_read_byte();//???
 802   1        value=(dath<<8)+datl;//???16???
 803   1      
 804   1        if((value&0xf800)==0xf800)//?????,???
 805   1        {
 806   2          value=(~value)+1; //??????1
 807   2          temp=value*(-0.0625);//???? 
 808   2        }
 809   1        else //???
 810   1        {
 811   2          temp=value*0.0625;  
 812   2        }
 813   1        return temp;
 814   1      }
 815          
 816          //?????????
 817          u8 soil_moisture_read(void)
 818          {
 819   1        u8 soil_moisture_adc;
 820   1        soil_moisture_adc=ADC_read_data(0);
 821   1        return soil_moisture_adc;
 822   1      }
 823          //???????
 824          u8 water_lavel_read(void)
 825          {
 826   1        u8 water_lavel_adc;
 827   1        water_lavel_adc=ADC_read_data(1);
 828   1        return water_lavel_adc;
 829   1      }
 830          
 831          //?DHT11??????
 832          //temp:???
 833          //humi:???
 834          u8 air_moisture_read(void)    
 835          {        
 836   1        u8 buf[5];
 837   1        u8 i;
 838   1        DHT11_Rst();
 839   1        if(DHT11_Check()==0)
 840   1        {
 841   2          for(i=0;i<5;i++)//??40???
 842   2          {
 843   3            buf[i]=DHT11_Read_Byte();
 844   3          }
 845   2          if((buf[0]+buf[1]+buf[2]+buf[3])==buf[4])
 846   2          {
 847   3            humi=buf[0];
 848   3            temp=buf[2];
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 15  

 849   3          }
 850   2          
 851   2        }   
 852   1      }
*** WARNING C173 IN LINE 852 OF main.c: missing return-expression
 853          
 854          //??????
 855          u8 light_intensity_read(void)
 856          {
 857   1        u8 light_value_adc;
 858   1        light_value_adc=xpt2046_read_adc_value(0xE4);
 859   1        return light_value_adc;
 860   1      }
 861          
 862          //???????,1????,0????
 863          void step_motor_control(u16 input){
 864   1          if(input!=StepMotor_status)
 865   1          {
 866   2              u8 key=0;
 867   2            u8 dir=0;//???????
 868   2            u8 speed=STEPMOTOR_MAXSPEED;//????????
 869   2            u8 step=0;
 870   2              u16 time=0;
 871   2              u16 usetime=STEPMOTOR_SHIELD_HIGHT*STEPMOTOR_SHIELD_RANGE;
 872   2      
 873   2              if(input==1)
 874   2              {
 875   3                  while(time<=usetime){
 876   4                      step_motor_28BYJ48_send_pulse(step++,dir);
 877   4                      time++;
 878   4                      if(step==8)step=0;    
 879   4                      delay_10us(speed);
 880   4                  }
 881   3            StepMotor_status=1;
 882   3              }
 883   2              if(input==0)
 884   2              {
 885   3                  dir=!dir;
 886   3                  while(time<=usetime){
 887   4                      step_motor_28BYJ48_send_pulse(step++,dir);
 888   4                      time++;
 889   4                      if(step==8)step=0;    
 890   4                      delay_10us(speed);
 891   4                  }
 892   3            StepMotor_status=0;
 893   3              }
 894   2          }
 895   1      }
 896          
 897          //??????,????????
 898          void pump_control(u16 input)
 899          {
 900   1          PUMP=1;
 901   1          delay_ms(input);
 902   1          PUMP=0;
 903   1      }
 904          
 905          //???????,1??,0??
 906          void spray_control(u16 input)
 907          {
 908   1          SPRAY=input;
 909   1      }
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 16  

 910          
 911          //???????,1??,0??
 912          void light_control(u16 input)
 913          {
 914   1          LIGHT=input;
 915   1      }
 916          
 917          
 918          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 919          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 920          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 921          
 922          void all_data_read(void)
 923          {
 924   1        //??
 925   1        temp_value=temperature_read()*10;
 926   1      
 927   1        if(temp_value<0)
 928   1        {
 929   2          temp_value=-temp_value;
 930   2          temp_buf[0]='-';  
 931   2        }
 932   1        else
 933   1          temp_buf[0]=' ';
 934   1        if(temp_value>=1000)
 935   1          temp_buf[1]=temp_value/1000+0x30;
 936   1        else
 937   1          temp_buf[1]=' ';
 938   1        temp_buf[2]=temp_value%1000/100+0x30;
 939   1        temp_buf[3]=temp_value%1000%100/10+0x30;
 940   1        temp_buf[4]='.';
 941   1        temp_buf[5]=temp_value%1000%100%10+0x30;
 942   1        temp_buf[6]='C';
 943   1        temp_buf[7]='\0'; 
 944   1      
 945   1        //????
 946   1        soil_moisture=soil_moisture_read();
 947   1      
 948   1        soil_moisture_buf[0]=soil_moisture%1000/100+0x30;
 949   1        soil_moisture_buf[1]=soil_moisture%1000%100/10+0x30;
 950   1        soil_moisture_buf[2]=soil_moisture%1000%100%10+0x30;
 951   1        soil_moisture_buf[3]='\0';
 952   1      
 953   1        //????
 954   1        soil_moisture=soil_moisture_read();
 955   1      
 956   1        soil_moisture_buf[0]=soil_moisture%1000/100+0x30;
 957   1        soil_moisture_buf[1]=soil_moisture%1000%100/10+0x30;
 958   1        soil_moisture_buf[2]=soil_moisture%1000%100%10+0x30;
 959   1        soil_moisture_buf[3]='\0';
 960   1      
 961   1        //????
 962   1        air_moisture_read();
 963   1        temp_buf2[0]=temp/10+0x30;  
 964   1        temp_buf2[1]=temp%10+0x30;
 965   1        temp_buf2[2]='\0';
 966   1      
 967   1        humi_buf[0]=humi/10+0x30; 
 968   1        humi_buf[1]=humi%10+0x30;
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 17  

 969   1        humi_buf[2]='\0';
 970   1      
 971   1        //????
 972   1        light_intensity=light_intensity_read();
 973   1        light_intensity_buf[0]=light_intensity%1000/100+0x30;
 974   1        light_intensity_buf[1]=light_intensity%1000%100/10+0x30;
 975   1        light_intensity_buf[2]=light_intensity%1000%100%10+0x30;
 976   1        light_intensity_buf[3]='\0';
 977   1      }
 978          
 979          void all_init(void)
 980          {
 981   1        lcd1602_init();
 982   1        lcd1602_show_string(0,0,"Self-testing");
 983   1        stay_time=0;
 984   1        ds18b20_init();
 985   1        DHT11_Init();
 986   1        pump_control(500);
 987   1        spray_control(0);
 988   1        light_control(0);
 989   1        lcd1602_init();
 990   1        lcd1602_show_string(0,0,"Self-test");
 991   1        lcd1602_show_string(0,1,"Success!!!");
 992   1      }
 993          
 994          
 995          
 996          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 997          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 998          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 999          //??????
1000          void test(void)
1001          {
1002   1        key=key_matrix_flip_scan();
1003   1        switch(key)
1004   1        {
1005   2          case(1):{
1006   3            lcd1602_init();
1007   3            lcd1602_show_string(0,0,"Temperature:");//?????
1008   3            lcd1602_show_string(0,1,temp_buf);//?????
1009   3            break;  
1010   3          }
1011   2          case(2):{
1012   3            lcd1602_init();
1013   3            lcd1602_show_string(0,0,"Soil Moisture:");//?????
1014   3            lcd1602_show_string(0,1,soil_moisture_buf);//?????
1015   3            break;  
1016   3          }
1017   2          case(3):{
1018   3            lcd1602_init();
1019   3            lcd1602_show_string(0,0,"Water Level:");//?????
1020   3            lcd1602_show_string(0,1,water_lavel_buf);//?????
1021   3            break;  
1022   3          }
1023   2          case(4):{
1024   3            lcd1602_init();
1025   3            lcd1602_show_string(0,0,"Air Moisture:");//?????
1026   3            lcd1602_show_string(0,1,humi_buf);//?????
1027   3            break;  
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 18  

1028   3          }
1029   2          case(5):{
1030   3            lcd1602_init();
1031   3            lcd1602_show_string(0,0,"Light Intensity:");//?????
1032   3            lcd1602_show_string(0,1,light_intensity_buf);//?????
1033   3            break;  
1034   3          }
1035   2          case(6):{
1036   3            lcd1602_init();
1037   3            lcd1602_show_string(0,0,"Shield Rising");
1038   3            step_motor_control(1);
1039   3            lcd1602_init();
1040   3            lcd1602_show_string(0,0,"Shield Rised");
1041   3            break;  
1042   3          }
1043   2          case(7):{
1044   3            lcd1602_init();
1045   3            lcd1602_show_string(0,0,"Shield Falling");
1046   3            step_motor_control(0);
1047   3            lcd1602_init();
1048   3            lcd1602_show_string(0,0,"Shield Falled");
1049   3            break;  
1050   3          }
1051   2          case(8):{
1052   3            lcd1602_init();
1053   3            lcd1602_show_string(0,0,"Pump Working");
1054   3            pump_control(5000);
1055   3            lcd1602_show_string(0,0,"Pump Worked 5s");
1056   3            break;  
1057   3          }
1058   2          case(9):{
1059   3            lcd1602_init();
1060   3            lcd1602_show_string(0,0,"Spray Work Begin");
1061   3            spray_control(1);
1062   3            break;  
1063   3          }
1064   2          case(10):{
1065   3            lcd1602_init();
1066   3            lcd1602_show_string(0,0,"Spray Work Stop");
1067   3            spray_control(0);
1068   3            break;  
1069   3          }
1070   2          case(11):{
1071   3            lcd1602_init();
1072   3            lcd1602_show_string(0,0,"LED Work Begin");
1073   3            light_control(1);
1074   3            break;  
1075   3          }
1076   2          case(12):{
1077   3            lcd1602_init();
1078   3            lcd1602_show_string(0,0,"LED Work Stop");
1079   3            light_control(0);
1080   3            break;  
1081   3          }
1082   2          case(13):{
1083   3            all_init();
1084   3            break;  
1085   3          }
1086   2          case(14):{
1087   3            break;  
1088   3          }
1089   2          case(15):{
C51 COMPILER V9.60.7.0   MAIN                                                              02/21/2025 18:12:21 PAGE 19  

1090   3            break;  
1091   3          }
1092   2          case(16):{
1093   3            break;  
1094   3          }
1095   2          default:{
1096   3            break;
1097   3          }
1098   2        }
1099   1      }
1100          
1101          
1102          
1103          
1104          
1105          
1106          
1107          
1108          int main()
1109          {
1110   1        all_init();
1111   1        while(1)
1112   1        {
1113   2          stay_time++;
1114   2          if(stay_time==22000)
1115   2          {
1116   3            all_data_read();
1117   3            stay_time=0;
1118   3          }
1119   2          test();
1120   2        }
1121   1      }
*** WARNING C290 IN LINE 852 OF main.c: missing return value


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2370    ----
   CONSTANT SIZE    =    252    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     43      25
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
