C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Program Files\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include"reg52.h"
   2          #include "intrins.h"
   3          
   4          
   5          //ç±»å‹å®šä¹‰
   6          typedef unsigned int u16;
   7          typedef unsigned char u8;
   8          
   9          
  10          //æ¥å£å®šä¹‰
  11          
  12          #define LCD1602_DATAPORT P0//LCDæ•°æ®ç«¯å£P0^0-P0^3
  13          sbit cs = P0^4;//ç‰‡é€‰ä½¿èƒ½ï¼Œä½ç”µå¹³æœ‰æ•ˆ
  14          sbit clk = P0^5;//èŠ¯ç‰‡æ—¶é’Ÿè¾“å…¥
  15          sbit dio = P0^6;//æ•°æ®è¾“å…¥DIä¸è¾“å‡ºDO
  16          sbit WIFI_IO=P0^7;//é¢„ç•™WiFiæ¥å£ä¸ºP0^7
  17          
  18          #define KEY_MATRIX_PORT P1//å¼€å‘æ¿çŸ©é˜µé”®ç›˜
  19          
  20          sbit PUMP=P2^0;//æ°´æ³µæ¥å…¥P2^0
  21          sbit SPRAY=P2^1;//é›¾åŒ–å™¨æ¥å…¥2^1
  22          sbit LIGHT=P2^2;//LEDè¡¥å…‰ç¯æ¥å…¥P2^2
  23          sbit MOISTURE_AIR=P2^3;//ç©ºæ°”æ¹¿åº¦ä¼ æ„Ÿå™¨æ¥å…¥P2^3
  24          sbit TEMPATURE=P2^4;//æ¸©åº¦ä¼ æ„Ÿå™¨æ¥å…¥P2^4
  25          sbit LCD1602_RW=P2^5;//LCDè¯»å†™é€‰æ‹©
  26          sbit LCD1602_RS=P2^6;//LCDæ•°æ®å‘½ä»¤é€‰æ‹©
  27          sbit LCD1602_E=P2^7; //LCDä½¿èƒ½ä¿¡å·
  28          
  29          sbit STEPMOTOR1=P3^0;//æ­¥è¿›ç”µæœº1æ¥å…¥P3^0
  30          sbit STEPMOTOR2=P3^1;//æ­¥è¿›ç”µæœº2æ¥å…¥P3^1
  31          sbit STEPMOTOR3=P3^2;//æ­¥è¿›ç”µæœº3æ¥å…¥P3^2
  32          sbit STEPMOTOR4=P3^3;//æ­¥è¿›ç”µæœº4æ¥å…¥P3^3
  33          sbit DIN  = P3^4;   //æ¿è½½ADCè¾“å…¥
  34          sbit CS   = P3^5;   //æ¿è½½ADCç‰‡é€‰
  35          sbit CLK  = P3^6;   //æ¿è½½ADCæ—¶é’Ÿ
  36          sbit DOUT = P3^7;   //æ¿è½½ADCè¾“å‡º
  37          
  38          //å…¨å±€æ•°æ®
  39          
  40          //LCD1602æ•°æ®å£4ä½å’Œ8ä½å®šä¹‰ï¼Œè‹¥ä¸º1ï¼Œåˆ™ä¸ºLCD1602å››ä½æ•°æ®å£é©±åŠ¨ï¼Œåä¹‹ä¸º8ä½
  41          #define LCD1602_4OR8_DATA_INTERFACE 1 //é»˜è®¤ä½¿ç”¨4ä½æ•°æ®å£LCD1602
  42          
  43          // å®šä¹‰æ­¥è¿›ç”µæœºé€Ÿåº¦ï¼Œå€¼è¶Šå°ï¼Œé€Ÿåº¦è¶Šå¿«
  44          #define STEPMOTOR_MAXSPEED        1//æ­¥è¿›ç”µæœºæœ€å¤§é€Ÿåº¦ï¼Œä¸èƒ½å°äº1
  45          #define STEPMOTOR_MINSPEED        5//æ­¥è¿›ç”µæœºæœ€å°é€Ÿåº¦
  46          #define STEPMOTOR_SHIELD_HIGHT    10//é®å…‰æ¿é«˜åº¦
  47          #define STEPMOTOR_SHIELD_RANGE    750//é®å…‰æ¿ç§»åŠ¨æ—¶é—´æ¯”ä¾‹
  48          
  49          //å…¨å±€å˜é‡
  50          //æ¢æµ‹é—´éš”æ—¶é—´å˜é‡
  51          u16 stay_time;
  52          
  53          //æ¸©åº¦ä¼ æ„Ÿå™¨å˜é‡
  54          u16 temp_value;
  55          u8 temp_buf[8];
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 2   

  56          
  57          //åœŸå£¤æ¹¿åº¦ä¼ æ„Ÿå™¨å˜é‡
  58          u16 soil_moisture;
  59          u8 soil_moisture_buf[4];
  60          
  61          //æ°´ä½ä¼ æ„Ÿå™¨å˜é‡
  62          u16 water_lavel;
  63          u8 water_lavel_buf[4];
  64          
  65          //ç©ºæ°”æ¹¿åº¦ä¼ æ„Ÿå™¨å˜é‡
  66          u8 temp=0;
  67          u8 humi=0;
  68          u8 i=0;
  69          u8 temp_buf2[3],humi_buf[3];
  70          
  71          //å…‰å¼ºä¼ æ„Ÿå™¨å˜é‡
  72          u16 light_intensity=0;
  73          u8 light_intensity_buf[4];
  74                  
  75          //æ­¥è¿›ç”µæœºé®å…‰æ¿çŠ¶æ€å˜é‡ï¼Œ0ä¸ºæœ€ä½ä½ç½®ï¼Œ1ä¸ºæœ€é«˜ä½ç½®
  76          u16 StepMotor_status=0;
  77          
  78          //æŒ‰é”®æ£€æµ‹å˜é‡
  79          u8 key=0;
  80          
  81          //test2å…è®¸å˜é‡
  82          u16 allow_test2=0;
  83          
  84          //pumpå…è®¸å˜é‡
  85          u16 allow_pump=0;
  86          
  87          //æ§åˆ¶æ•°æ®
  88          u16 need_temp=230;
  89          u16 need_light_intensity=128;
  90          u16 need_soil_moisture=0;
  91          u16 need_water_lavel=0;
  92          u16 need_air_moisture=23;
  93          //å…¬å…±å‡½æ•°
  94          
  95          //å»¶æ—¶2us
  96          void Delay_2us(void)
  97          {
  98   1        _nop_();
  99   1        _nop_();
 100   1      }
 101          
 102          //å»¶æ—¶å‡½æ•°ï¼Œè¾“å…¥int xï¼Œå»¶æ—¶x/100æ¯«ç§’
 103          void delay_10us(u16 ten_us){
 104   1      while(ten_us--);
 105   1      }
 106          
 107          //å»¶æ—¶å‡½æ•°ï¼Œè¾“å…¥int xï¼Œå»¶æ—¶xæ¯«ç§’
 108          void delay_ms(u16 ms)
 109          {
 110   1        u16 i,j;
 111   1        for(i=ms;i>0;i--)
 112   1          for(j=110;j>0;j--);
 113   1      }
 114          
 115          //æ•°æ¨¡è½¬æ¢å‡½æ•°éƒ¨åˆ†
 116          
 117          //æ¿è½½ADC2046è½¬æ¢
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 3   

 118          /*******************************************************************************
 119          * å‡½ æ•° å       : xpt2046_wirte_data
 120          * å‡½æ•°åŠŸèƒ½     : XPT2046å†™æ•°æ®
 121          * è¾“    å…¥       : datï¼šå†™å…¥çš„æ•°æ®
 122          * è¾“    å‡º       : æ— 
 123          *******************************************************************************/
 124          void xpt2046_wirte_data(u8 dat)
 125          {
 126   1        u8 i;
 127   1      
 128   1        CLK = 0;
 129   1        _nop_();
 130   1        for(i=0;i<8;i++)//å¾ªç¯8æ¬¡ï¼Œæ¯æ¬¡ä¼ è¾“ä¸€ä½ï¼Œå…±ä¸€ä¸ªå­—èŠ‚
 131   1        {
 132   2          DIN = dat >> 7;//å…ˆä¼ é«˜ä½å†ä¼ ä½ä½
 133   2          dat <<= 1;//å°†ä½ä½ç§»åˆ°é«˜ä½
 134   2          CLK = 0;//CLKç”±ä½åˆ°é«˜äº§ç”Ÿä¸€ä¸ªä¸Šå‡æ²¿ï¼Œä»è€Œå†™å…¥æ•°æ®
 135   2          _nop_();  
 136   2          CLK = 1;
 137   2          _nop_();
 138   2        }
 139   1      }
 140          
 141          /*******************************************************************************
 142          * å‡½ æ•° å       : xpt2046_read_data
 143          * å‡½æ•°åŠŸèƒ½     : XPT2046è¯»æ•°æ®
 144          * è¾“    å…¥       : æ— 
 145          * è¾“    å‡º       : XPT2046è¿”å›12ä½æ•°æ®
 146          *******************************************************************************/
 147          u16 xpt2046_read_data(void)
 148          {
 149   1        u8 i;
 150   1        u16 dat=0;
 151   1      
 152   1        CLK = 0;
 153   1        _nop_();
 154   1        for(i=0;i<12;i++)//å¾ªç¯12æ¬¡ï¼Œæ¯æ¬¡è¯»å–ä¸€ä½ï¼Œå¤§äºä¸€ä¸ªå­—èŠ‚æ•°ï¼Œæ‰€ä»¥è¿”å›å€¼ç±»å‹æ˜¯u16
 155   1        {
 156   2          dat <<= 1;
 157   2          CLK = 1;
 158   2          _nop_();
 159   2          CLK = 0; //CLKç”±é«˜åˆ°ä½äº§ç”Ÿä¸€ä¸ªä¸‹é™æ²¿ï¼Œä»è€Œè¯»å–æ•°æ®
 160   2          _nop_();
 161   2          dat |= DOUT;//å…ˆè¯»å–é«˜ä½ï¼Œå†è¯»å–ä½ä½ã€‚  
 162   2        }
 163   1        return dat; 
 164   1      }
 165          
 166          /*******************************************************************************
 167          * å‡½ æ•° å       : xpt2046_read_adc_value
 168          * å‡½æ•°åŠŸèƒ½     : XPT2046è¯»ADæ•°æ®
 169          * è¾“    å…¥       : cmdï¼šæŒ‡ä»¤
 170          * è¾“    å‡º       : XPT2046è¿”å›ADå€¼
 171          *******************************************************************************///////////////////////////
             -///////////////////////
 172          u16 xpt2046_read_adc_value(u8 cmd)
 173          {
 174   1        u8 i;
 175   1        u16 adc_value=0;
 176   1      
 177   1        CLK = 0;//å…ˆæ‹‰ä½æ—¶é’Ÿ
 178   1        CS  = 0;//ä½¿èƒ½XPT2046
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 4   

 179   1        xpt2046_wirte_data(cmd);//å‘é€å‘½ä»¤å­—
 180   1        for(i=6; i>0; i--);//å»¶æ—¶ç­‰å¾…è½¬æ¢ç»“æœ
 181   1        CLK = 1;
 182   1        _nop_();
 183   1        CLK = 0;//å‘é€ä¸€ä¸ªæ—¶é’Ÿï¼Œæ¸…é™¤BUSY
 184   1        _nop_();
 185   1        adc_value=xpt2046_read_data();
 186   1        CS = 1;//å…³é—­XPT2046
 187   1        return adc_value;
 188   1      }
 189          
 190          //å¤–æ¥ADC0832
 191          /*****************************************
 192          å‡½æ•°ç®€ä»‹ï¼šè·å–ADC0832æ•°æ®
 193          å‡½æ•°åç§°ï¼šADC_read_data(bit channel)
 194          å‚æ•°è¯´æ˜ï¼šchä¸ºå…¥å£å‚æ•°ï¼Œch=0é€‰æ‹©é€šé“0ï¼Œch=1é€‰æ‹©é€šé“1
 195          å‡½æ•°è¿”å›ï¼šè¿”å›è¯»å–åˆ°çš„äºŒè¿›åˆ¶ADCæ•°æ®ï¼Œæ ¼å¼ä¸ºunsigned char
 196                å½“è¿”å›ä¸€ç›´0æ—¶ï¼Œè½¬æ¢æ•°æ®æœ‰è¯¯
 197          ******************************************/
 198          u8 ADC_read_data(bit channel)
 199          {
 200   1        u8 i,dat0=0,dat1=0;
 201   1        //------ç¬¬1æ¬¡ä¸‹é™æ²¿ä¹‹å‰diç½®é«˜ï¼Œå¯åŠ¨ä¿¡å·---------
 202   1      
 203   1        cs=0;     //ç‰‡é€‰ä¿¡å·ç½®ä½ï¼Œå¯åŠ¨ADè½¬æ¢èŠ¯ç‰‡
 204   1        clk=0;      //æ—¶é’Ÿç½®ä½å¹³
 205   1        
 206   1        dio=1;      //å¼€å§‹ä¿¡å·ä¸ºé«˜ç”µå¹³
 207   1        Delay_2us();
 208   1        clk=1;      //äº§ç”Ÿä¸€ä¸ªæ­£è„‰å†²,åœ¨æ—¶é’Ÿä¸Šå‡æ²¿ï¼Œè¾“å…¥å¼€å§‹ä¿¡å·ï¼ˆDI=1ï¼‰
 209   1        Delay_2us();
 210   1          clk=0;      //ç¬¬1ä¸ªæ—¶é’Ÿä¸‹é™æ²¿
 211   1        dio=1;
 212   1        Delay_2us();
 213   1        
 214   1        clk=1;        // ç¬¬2ä¸ªä¸‹é™æ²¿è¾“å…¥DI=1ï¼Œè¡¨ç¤ºåŒé€šé“å•ææ€§è¾“å…¥
 215   1        Delay_2us();   
 216   1        //------åœ¨ç¬¬2ä¸ªä¸‹é™æ²¿ï¼Œæ¨¡æ‹Ÿä¿¡å·è¾“å…¥æ¨¡å¼é€‰æ‹©ï¼ˆ1ï¼šå•æ¨¡ä¿¡å·ï¼Œ0ï¼šåŒæ¨¡å·®åˆ†ä¿¡å·
             -ï¼‰---------    
 217   1        clk=0;  
 218   1        dio=channel;         // ç¬¬3ä¸ªä¸‹é™æ²¿,è®¾ç½®DIï¼Œé€‰æ‹©é€šé“;
 219   1        Delay_2us();
 220   1        clk=1;
 221   1        Delay_2us();
 222   1      
 223   1         //------åœ¨ç¬¬3ä¸ªä¸‹é™æ²¿ï¼Œæ¨¡æ‹Ÿä¿¡å·è¾“å…¥é€šé“é€‰æ‹©ï¼ˆ1ï¼šé€šé“CH1ï¼Œ0ï¼šé€šé“CH0ï¼‰--------
             -----  
 224   1        
 225   1        clk=0;
 226   1        dio=1;          //ç¬¬å››ä¸ªä¸‹é™æ²¿ä¹‹å‰ï¼ŒDIç½®é«˜ï¼Œå‡†å¤‡æ¥æ”¶æ•° 
 227   1        Delay_2us();  
 228   1        for(i=0;i<8;i++)                 //ç¬¬4~11å…±8ä¸ªä¸‹é™æ²¿è¯»æ•°æ®ï¼ˆMSB->LSBï¼‰
 229   1        {
 230   2          clk=1;
 231   2          Delay_2us();
 232   2          clk=0;
 233   2          Delay_2us();
 234   2          dat0=dat0<<1|dio;
 235   2        }
 236   1        for(i=0;i<8;i++)                 //ç¬¬11~18å…±8ä¸ªä¸‹é™æ²¿è¯»æ•°æ®ï¼ˆLSB->MSBï¼‰
 237   1        {
 238   2          dat1=dat1|((u8)(dio)<<i);
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 5   

 239   2          clk=1;
 240   2          Delay_2us();
 241   2          clk=0;
 242   2          Delay_2us();
 243   2        } 
 244   1        cs=1;         
 245   1        return (dat0==dat1)?dat0:0;     //åˆ¤æ–­dat0ä¸dat1æ˜¯å¦ç›¸ç­‰
 246   1      }
 247          
 248          //LCDå‡½æ•°å®šä¹‰
 249          /*******************************************************************************
 250          * å‡½ æ•° å       : lcd1602_write_cmd
 251          * å‡½æ•°åŠŸèƒ½     : LCD1602å†™å‘½ä»¤
 252          * è¾“    å…¥       : cmdï¼šæŒ‡ä»¤
 253          * è¾“    å‡º       : æ— 
 254          *******************************************************************************/
 255          #if (LCD1602_4OR8_DATA_INTERFACE==0)//8ä½LCD
              void lcd1602_write_cmd(u8 cmd)
              {
                LCD1602_RS=0;//é€‰æ‹©å‘½ä»¤
                LCD1602_RW=0;//é€‰æ‹©å†™
                LCD1602_E=0;
                LCD1602_DATAPORT=cmd;//å‡†å¤‡å‘½ä»¤
                delay_ms(1);
                LCD1602_E=1;//ä½¿èƒ½è„šEå…ˆä¸Šå‡æ²¿å†™å…¥
                delay_ms(1);
                LCD1602_E=0;//ä½¿èƒ½è„šEåè´Ÿè·³å˜å®Œæˆå†™å…¥  
              }
              #else //4ä½LCD
 268          void lcd1602_write_cmd(u8 cmd)
 269          {
 270   1        LCD1602_RS=0;//é€‰æ‹©å‘½ä»¤
 271   1        LCD1602_RW=0;//é€‰æ‹©å†™
 272   1        LCD1602_E=0;
 273   1        LCD1602_DATAPORT=cmd;//å‡†å¤‡å‘½ä»¤
 274   1        delay_ms(1);
 275   1        LCD1602_E=1;//ä½¿èƒ½è„šEå…ˆä¸Šå‡æ²¿å†™å…¥
 276   1        delay_ms(1);
 277   1        LCD1602_E=0;//ä½¿èƒ½è„šEåè´Ÿè·³å˜å®Œæˆå†™å…¥
 278   1        
 279   1        LCD1602_DATAPORT=cmd<<4;//å‡†å¤‡å‘½ä»¤
 280   1        delay_ms(1);
 281   1        LCD1602_E=1;//ä½¿èƒ½è„šEå…ˆä¸Šå‡æ²¿å†™å…¥
 282   1        delay_ms(1);
 283   1        LCD1602_E=0;//ä½¿èƒ½è„šEåè´Ÿè·³å˜å®Œæˆå†™å…¥  
 284   1      }
 285          #endif
 286          
 287          /*******************************************************************************
 288          * å‡½ æ•° å       : lcd1602_write_data
 289          * å‡½æ•°åŠŸèƒ½     : LCD1602å†™æ•°æ®
 290          * è¾“    å…¥       : datï¼šæ•°æ®
 291          * è¾“    å‡º       : æ— 
 292          *******************************************************************************/
 293          #if (LCD1602_4OR8_DATA_INTERFACE==0)//8ä½LCD
              void lcd1602_write_data(u8 dat) 
              {
                LCD1602_RS=1;//é€‰æ‹©æ•°æ®
                LCD1602_RW=0;//é€‰æ‹©å†™
                LCD1602_E=0;
                LCD1602_DATAPORT=dat;//å‡†å¤‡æ•°æ®
                delay_ms(1);
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 6   

                LCD1602_E=1;//ä½¿èƒ½è„šEå…ˆä¸Šå‡æ²¿å†™å…¥
                delay_ms(1);
                LCD1602_E=0;//ä½¿èƒ½è„šEåè´Ÿè·³å˜å®Œæˆå†™å…¥    
              }
              #else
 306          void lcd1602_write_data(u8 dat) 
 307          {
 308   1        LCD1602_RS=1;//é€‰æ‹©æ•°æ®
 309   1        LCD1602_RW=0;//é€‰æ‹©å†™
 310   1        LCD1602_E=0;
 311   1        LCD1602_DATAPORT=dat;//å‡†å¤‡æ•°æ®
 312   1        delay_ms(1);
 313   1        LCD1602_E=1;//ä½¿èƒ½è„šEå…ˆä¸Šå‡æ²¿å†™å…¥
 314   1        delay_ms(1);
 315   1        LCD1602_E=0;//ä½¿èƒ½è„šEåè´Ÿè·³å˜å®Œæˆå†™å…¥
 316   1        
 317   1        LCD1602_DATAPORT=dat<<4;//å‡†å¤‡æ•°æ®
 318   1        delay_ms(1);
 319   1        LCD1602_E=1;//ä½¿èƒ½è„šEå…ˆä¸Šå‡æ²¿å†™å…¥
 320   1        delay_ms(1);
 321   1        LCD1602_E=0;//ä½¿èƒ½è„šEåè´Ÿè·³å˜å®Œæˆå†™å…¥    
 322   1      }
 323          #endif
 324          
 325          /*******************************************************************************
 326          * å‡½ æ•° å       : lcd1602_init
 327          * å‡½æ•°åŠŸèƒ½     : LCD1602åˆå§‹åŒ–
 328          * è¾“    å…¥       : æ— 
 329          * è¾“    å‡º       : æ— 
 330          *******************************************************************************///////////////////////////
             -///////////////////////
 331          #if (LCD1602_4OR8_DATA_INTERFACE==0)//8ä½LCD
              void lcd1602_init(void)
              {
                lcd1602_write_cmd(0x38);//æ•°æ®æ€»çº¿8ä½ï¼Œæ˜¾ç¤º2è¡Œï¼Œ5*7ç‚¹é˜µ/å­—ç¬¦
                lcd1602_write_cmd(0x0c);//æ˜¾ç¤ºåŠŸèƒ½å¼€ï¼Œæ— å…‰æ ‡ï¼Œå…‰æ ‡é—ªçƒ
                lcd1602_write_cmd(0x06);//å†™å…¥æ–°æ•°æ®åå…‰æ ‡å³ç§»ï¼Œæ˜¾ç¤ºå±ä¸ç§»åŠ¨
                lcd1602_write_cmd(0x01);//æ¸…å±  
              }
              #else
 340          void lcd1602_init(void)
 341          {
 342   1        lcd1602_write_cmd(0x28);//æ•°æ®æ€»çº¿4ä½ï¼Œæ˜¾ç¤º2è¡Œï¼Œ5*7ç‚¹é˜µ/å­—ç¬¦
 343   1        lcd1602_write_cmd(0x0c);//æ˜¾ç¤ºåŠŸèƒ½å¼€ï¼Œæ— å…‰æ ‡ï¼Œå…‰æ ‡é—ªçƒ
 344   1        lcd1602_write_cmd(0x06);//å†™å…¥æ–°æ•°æ®åå…‰æ ‡å³ç§»ï¼Œæ˜¾ç¤ºå±ä¸ç§»åŠ¨
 345   1        lcd1602_write_cmd(0x01);//æ¸…å±  
 346   1      }
 347          #endif
 348          
 349          /*******************************************************************************
 350          * å‡½ æ•° å       : lcd1602_clear
 351          * å‡½æ•°åŠŸèƒ½     : LCD1602æ¸…å±
 352          * è¾“    å…¥       : æ— 
 353          * è¾“    å‡º       : æ— 
 354          *******************************************************************************/
 355          void lcd1602_clear(void)
 356          {
 357   1        lcd1602_write_cmd(0x01);  
 358   1      }
 359          
 360          /*******************************************************************************
 361          * å‡½ æ•° å       : lcd1602_show_string
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 7   

 362          * å‡½æ•°åŠŸèƒ½     : LCD1602æ˜¾ç¤ºå­—ç¬¦
 363          * è¾“    å…¥       : x,yï¼šæ˜¾ç¤ºåæ ‡ï¼Œx=0~15ï¼Œy=0~1;
 364                     strï¼šæ˜¾ç¤ºå­—ç¬¦ä¸²
 365          * è¾“    å‡º       : æ— 
 366          *******************************************************************************///////////////////////////
             -///////////////////////
 367          void lcd1602_show_string(u8 x,u8 y,u8 *str)
 368          {
 369   1        u8 i=0;
 370   1      
 371   1        if(y>1||x>15)return;//è¡Œåˆ—å‚æ•°ä¸å¯¹åˆ™å¼ºåˆ¶é€€å‡º
 372   1      
 373   1        if(y<1) //ç¬¬1è¡Œæ˜¾ç¤º
 374   1        { 
 375   2          while(*str!='\0')//å­—ç¬¦ä¸²æ˜¯ä»¥'\0'ç»“å°¾ï¼Œåªè¦å‰é¢æœ‰å†…å®¹å°±æ˜¾ç¤º
 376   2          {
 377   3            if(i<16-x)//å¦‚æœå­—ç¬¦é•¿åº¦è¶…è¿‡ç¬¬ä¸€è¡Œæ˜¾ç¤ºèŒƒå›´ï¼Œåˆ™åœ¨ç¬¬äºŒè¡Œç»§ç»­æ˜¾ç¤º
 378   3            {
 379   4              lcd1602_write_cmd(0x80+i+x);//ç¬¬ä¸€è¡Œæ˜¾ç¤ºåœ°å€è®¾ç½® 
 380   4            }
 381   3            else
 382   3            {
 383   4              lcd1602_write_cmd(0x40+0x80+i+x-16);//ç¬¬äºŒè¡Œæ˜¾ç¤ºåœ°å€è®¾ç½® 
 384   4            }
 385   3            lcd1602_write_data(*str);//æ˜¾ç¤ºå†…å®¹
 386   3            str++;//æŒ‡é’ˆé€’å¢
 387   3            i++;  
 388   3          } 
 389   2        }
 390   1        else  //ç¬¬2è¡Œæ˜¾ç¤º
 391   1        {
 392   2          while(*str!='\0')
 393   2          {
 394   3            if(i<16-x) //å¦‚æœå­—ç¬¦é•¿åº¦è¶…è¿‡ç¬¬äºŒè¡Œæ˜¾ç¤ºèŒƒå›´ï¼Œåˆ™åœ¨ç¬¬ä¸€è¡Œç»§ç»­æ˜¾ç¤º
 395   3            {
 396   4              lcd1602_write_cmd(0x80+0x40+i+x); 
 397   4            }
 398   3            else
 399   3            {
 400   4              lcd1602_write_cmd(0x80+i+x-16); 
 401   4            }
 402   3            lcd1602_write_data(*str);
 403   3            str++;
 404   3            i++;  
 405   3          } 
 406   2        }       
 407   1      }
 408          
 409          //çŸ©é˜µé”®ç›˜å‡½æ•°
 410          /*******************************************************************************
 411          * å‡½ æ•° å       : key_matrix_flip_scan
 412          * å‡½æ•°åŠŸèƒ½     : ä½¿ç”¨çº¿ç¿»è½¬æ‰«ææ–¹æ³•ï¼Œæ£€æµ‹çŸ©é˜µæŒ‰é”®æ˜¯å¦æŒ‰ä¸‹ï¼ŒæŒ‰ä¸‹åˆ™è¿”å›å¯¹åº”é”®
             -å€¼
 413          * è¾“    å…¥       : æ— 
 414          * è¾“    å‡º       : key_valueï¼š1-16ï¼Œå¯¹åº”S1-S16é”®ï¼Œ
 415                     0ï¼šæŒ‰é”®æœªæŒ‰ä¸‹
 416          *******************************************************************************///////////////////////////
             -///////////////////////
 417          u8 key_matrix_flip_scan(void)
 418          {
 419   1        static u8 key_value=0;
 420   1      
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 8   

 421   1        KEY_MATRIX_PORT=0x0f;//ç»™æ‰€æœ‰è¡Œèµ‹å€¼0ï¼Œåˆ—å…¨ä¸º1
 422   1        if(KEY_MATRIX_PORT!=0x0f)//åˆ¤æ–­æŒ‰é”®æ˜¯å¦æŒ‰ä¸‹
 423   1        {
 424   2          delay_10us(1000);//æ¶ˆæŠ–
 425   2          if(KEY_MATRIX_PORT!=0x0f)
 426   2          {
 427   3            //æµ‹è¯•åˆ—
 428   3            KEY_MATRIX_PORT=0x0f;
 429   3            switch(KEY_MATRIX_PORT)//ä¿å­˜è¡Œä¸º0ï¼ŒæŒ‰é”®æŒ‰ä¸‹åçš„åˆ—å€¼ 
 430   3            {
 431   4              case 0x07: key_value=1;break;
 432   4              case 0x0b: key_value=2;break;
 433   4              case 0x0d: key_value=3;break;
 434   4              case 0x0e: key_value=4;break;
 435   4            }
 436   3            //æµ‹è¯•è¡Œ
 437   3            KEY_MATRIX_PORT=0xf0;
 438   3            switch(KEY_MATRIX_PORT)//ä¿å­˜åˆ—ä¸º0ï¼ŒæŒ‰é”®æŒ‰ä¸‹åçš„é”®å€¼ 
 439   3            {
 440   4              case 0x70: key_value=key_value;break;
 441   4              case 0xb0: key_value=key_value+4;break;
 442   4              case 0xd0: key_value=key_value+8;break;
 443   4              case 0xe0: key_value=key_value+12;break;
 444   4            }
 445   3            while(KEY_MATRIX_PORT!=0xf0);//ç­‰å¾…æŒ‰é”®æ¾å¼€ 
 446   3          }
 447   2        }
 448   1        else
 449   1          key_value=0;    
 450   1        
 451   1        return key_value;   
 452   1      }
 453          
 454          //æ­¥è¿›ç”µæœºæ“ä½œå‡½æ•°
 455          /*******************************************************************************
 456          * å‡½ æ•° å       : step_motor_28BYJ48_send_pulse
 457          * å‡½æ•°åŠŸèƒ½     : è¾“å‡ºä¸€ä¸ªæ•°æ®ç»™ULN2003ä»è€Œå®ç°å‘æ­¥è¿›ç”µæœºå‘é€ä¸€ä¸ªè„‰å†²
 458          * è¾“    å…¥       : stepï¼šæŒ‡å®šæ­¥è¿›åºå·ï¼Œå¯é€‰å€¼0~7
 459                     dirï¼šæ–¹å‘é€‰æ‹©,1ï¼šé¡ºæ—¶é’ˆ,0ï¼šé€†æ—¶é’ˆ
 460          * è¾“    å‡º       : æ— 
 461          *******************************************************************************/
 462          void step_motor_28BYJ48_send_pulse(u8 step,u8 dir)
 463          {
 464   1        u8 temp=step;
 465   1        
 466   1        if(dir==0)  //å¦‚æœä¸ºé€†æ—¶é’ˆæ—‹è½¬
 467   1          temp=7-step;//è°ƒæ¢èŠ‚æ‹ä¿¡å·
 468   1        switch(temp)//8ä¸ªèŠ‚æ‹æ§åˆ¶ï¼šA->AB->B->BC->C->CD->D->DA
 469   1        {
 470   2          case 0: STEPMOTOR1=1;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=0;break;
 471   2          case 1: STEPMOTOR1=1;STEPMOTOR2=1;STEPMOTOR3=0;STEPMOTOR4=0;break;
 472   2          case 2: STEPMOTOR1=0;STEPMOTOR2=1;STEPMOTOR3=0;STEPMOTOR4=0;break;
 473   2          case 3: STEPMOTOR1=0;STEPMOTOR2=1;STEPMOTOR3=1;STEPMOTOR4=0;break;
 474   2          case 4: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=1;STEPMOTOR4=0;break;
 475   2          case 5: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=1;STEPMOTOR4=1;break;
 476   2          case 6: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=1;break;
 477   2          case 7: STEPMOTOR1=1;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=1;break;
 478   2          default: STEPMOTOR1=0;STEPMOTOR2=0;STEPMOTOR3=0;STEPMOTOR4=0;break;//åœæ­¢ç›¸åº 
 479   2        }     
 480   1      }
 481          
 482          // //æ“ä½œå‡½æ•°ï¼Œ1ä¸Šåˆ°é¡¶ç«¯ï¼Œ0ä¸‹åˆ°åº•ç«¯/////////////////////////////////////////////////////////
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 9   

             -/////////////////////////////////////////
 483          // void step_motor_control(u16 input){
 484          //     if(input!=StepMotor_status)
 485          //     {
 486          //      u8 dir=0;//é»˜è®¤é€†æ—¶é’ˆæ–¹å‘
 487          //      u8 speed=STEPMOTOR_MAXSPEED;//é»˜è®¤æœ€å¤§é€Ÿåº¦æ—‹è½¬
 488          //      u8 step=0;
 489          //         u16 time=0;
 490          //         u16 usetime=STEPMOTOR_SHIELD_HIGHT*STEPMOTOR_SHIELD_RANGE;
 491          
 492          //         if(input==1)
 493          //         {
 494          //             while(time<=usetime){
 495          //                 step_motor_28BYJ48_send_pulse(step++,dir);
 496          //                time++;
 497          //                if(step==8)step=0;    
 498          //                delay_10us(speed);
 499          //             }
 500          //      StepMotor_status=1;
 501          //         }
 502          //         if(input==0)
 503          //         {
 504          //             dir=!dir;
 505          //             while(time<=usetime){
 506          //                 step_motor_28BYJ48_send_pulse(step++,dir);
 507          //                time++;
 508          //                if(step==8)step=0;    
 509          //                delay_10us(speed);
 510          //             }
 511          //      StepMotor_status=0;
 512          //         }
 513          //     }
 514          // }
 515          
 516          //æ¸©åº¦ä¼ æ„Ÿå™¨æ“ä½œå‡½æ•°
 517          /*******************************************************************************
 518          * å‡½ æ•° å         : ds18b20_reset
 519          * å‡½æ•°åŠŸèƒ½       : å¤ä½DS18B20  
 520          * è¾“    å…¥         : æ— 
 521          * è¾“    å‡º         : æ— 
 522          *******************************************************************************/
 523          void ds18b20_reset(void)
 524          {
 525   1        TEMPATURE=0;  //æ‹‰ä½DQ
 526   1        delay_10us(75); //æ‹‰ä½750us
 527   1        TEMPATURE=1;  //DQ=1
 528   1        delay_10us(2);  //20US
 529   1      }
 530          
 531          /*******************************************************************************
 532          * å‡½ æ•° å         : ds18b20_check
 533          * å‡½æ•°åŠŸèƒ½       : æ£€æµ‹DS18B20æ˜¯å¦å­˜åœ¨
 534          * è¾“    å…¥         : æ— 
 535          * è¾“    å‡º         : 1:æœªæ£€æµ‹åˆ°DS18B20çš„å­˜åœ¨ï¼Œ0:å­˜åœ¨
 536          *******************************************************************************/
 537          u8 ds18b20_check(void)
 538          {
 539   1        u8 time_temp=0;
 540   1      
 541   1        while(TEMPATURE&&time_temp<20)  //ç­‰å¾…DQä¸ºä½ç”µå¹³
 542   1        {
 543   2          time_temp++;
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 10  

 544   2          delay_10us(1);  
 545   2        }
 546   1        if(time_temp>=20)return 1;  //å¦‚æœè¶…æ—¶åˆ™å¼ºåˆ¶è¿”å›1
 547   1        else time_temp=0;
 548   1        while((!TEMPATURE)&&time_temp<20) //ç­‰å¾…DQä¸ºé«˜ç”µå¹³
 549   1        {
 550   2          time_temp++;
 551   2          delay_10us(1);
 552   2        }
 553   1        if(time_temp>=20)return 1;  //å¦‚æœè¶…æ—¶åˆ™å¼ºåˆ¶è¿”å›1
 554   1        return 0;
 555   1      }
 556          
 557          /*******************************************************************************
 558          * å‡½ æ•° å         : ds18b20_read_bit
 559          * å‡½æ•°åŠŸèƒ½       : ä»DS18B20è¯»å–ä¸€ä¸ªä½
 560          * è¾“    å…¥         : æ— 
 561          * è¾“    å‡º         : 1/0
 562          *******************************************************************************/
 563          u8 ds18b20_read_bit(void)
 564          {
 565   1        u8 dat=0;
 566   1        
 567   1        TEMPATURE=0;
 568   1        _nop_();_nop_();
 569   1        TEMPATURE=1;  
 570   1        _nop_();_nop_(); //è¯¥æ®µæ—¶é—´ä¸èƒ½è¿‡é•¿ï¼Œå¿…é¡»åœ¨15uså†…è¯»å–æ•°æ®
 571   1        if(TEMPATURE)dat=1; //å¦‚æœæ€»çº¿ä¸Šä¸º1åˆ™æ•°æ®datä¸º1ï¼Œå¦åˆ™ä¸º0
 572   1        else dat=0;
 573   1        delay_10us(5);
 574   1        return dat;
 575   1      } 
 576          
 577          /*******************************************************************************
 578          * å‡½ æ•° å         : ds18b20_read_byte
 579          * å‡½æ•°åŠŸèƒ½       : ä»DS18B20è¯»å–ä¸€ä¸ªå­—èŠ‚
 580          * è¾“    å…¥         : æ— 
 581          * è¾“    å‡º         : ä¸€ä¸ªå­—èŠ‚æ•°æ®
 582          *******************************************************************************/
 583          u8 ds18b20_read_byte(void)
 584          {
 585   1        u8 i=0;
 586   1        u8 dat=0;
 587   1        u8 temp=0;
 588   1      
 589   1        for(i=0;i<8;i++)//å¾ªç¯8æ¬¡ï¼Œæ¯æ¬¡è¯»å–ä¸€ä½ï¼Œä¸”å…ˆè¯»ä½ä½å†è¯»é«˜ä½
 590   1        {
 591   2          temp=ds18b20_read_bit();
 592   2          dat=(temp<<7)|(dat>>1);
 593   2        }
 594   1        return dat; 
 595   1      }
 596          
 597          /*******************************************************************************
 598          * å‡½ æ•° å         : ds18b20_write_byte
 599          * å‡½æ•°åŠŸèƒ½       : å†™ä¸€ä¸ªå­—èŠ‚åˆ°DS18B20
 600          * è¾“    å…¥         : datï¼šè¦å†™å…¥çš„å­—èŠ‚
 601          * è¾“    å‡º         : æ— 
 602          *******************************************************************************/
 603          void ds18b20_write_byte(u8 dat)
 604          {
 605   1        u8 i=0;
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 11  

 606   1        u8 temp=0;
 607   1      
 608   1        for(i=0;i<8;i++)//å¾ªç¯8æ¬¡ï¼Œæ¯æ¬¡å†™ä¸€ä½ï¼Œä¸”å…ˆå†™ä½ä½å†å†™é«˜ä½
 609   1        {
 610   2          temp=dat&0x01;//é€‰æ‹©ä½ä½å‡†å¤‡å†™å…¥
 611   2          dat>>=1;//å°†æ¬¡é«˜ä½ç§»åˆ°ä½ä½
 612   2          if(temp)
 613   2          {
 614   3            TEMPATURE=0;
 615   3            _nop_();_nop_();
 616   3            TEMPATURE=1;  
 617   3            delay_10us(6);
 618   3          }
 619   2          else
 620   2          {
 621   3            TEMPATURE=0;
 622   3            delay_10us(6);
 623   3            TEMPATURE=1;
 624   3            _nop_();_nop_();  
 625   3          } 
 626   2        } 
 627   1      }
 628          
 629          /*******************************************************************************
 630          * å‡½ æ•° å         : ds18b20_start
 631          * å‡½æ•°åŠŸèƒ½       : å¼€å§‹æ¸©åº¦è½¬æ¢
 632          * è¾“    å…¥         : æ— 
 633          * è¾“    å‡º         : æ— 
 634          *******************************************************************************/
 635          void ds18b20_start(void)
 636          {
 637   1        ds18b20_reset();//å¤ä½
 638   1        ds18b20_check();//æ£€æŸ¥DS18B20
 639   1        ds18b20_write_byte(0xcc);//SKIP ROM
 640   1          ds18b20_write_byte(0x44);//è½¬æ¢å‘½ä»¤ 
 641   1      }
 642          
 643          /*******************************************************************************
 644          * å‡½ æ•° å         : ds18b20_init
 645          * å‡½æ•°åŠŸèƒ½       : åˆå§‹åŒ–DS18B20çš„IOå£ DQ åŒæ—¶æ£€æµ‹DSçš„å­˜åœ¨
 646          * è¾“    å…¥         : æ— 
 647          * è¾“    å‡º         : 1:ä¸å­˜åœ¨ï¼Œ0:å­˜åœ¨
 648          *******************************************************************************///////////////////////////
             -///////////////////////
 649          u8 ds18b20_init(void)
 650          {
 651   1        ds18b20_reset();
 652   1        return ds18b20_check(); 
 653   1      }
 654          
 655          /*******************************************************************************
 656          * å‡½ æ•° å         : ds18b20_read_temperture
 657          * å‡½æ•°åŠŸèƒ½       : ä»ds18b20å¾—åˆ°æ¸©åº¦å€¼
 658          * è¾“    å…¥         : æ— 
 659          * è¾“    å‡º         : æ¸©åº¦æ•°æ®
 660          *******************************************************************************///////////////////////////
             -///////////////////////
 661          // float temperature_read(void)
 662          // {
 663          //  float temp;
 664          //  u8 dath=0;
 665          //  u8 datl=0;
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 12  

 666          //  u16 value=0;
 667          
 668          //  ds18b20_start();//å¼€å§‹è½¬æ¢
 669          //  ds18b20_reset();//å¤ä½
 670          //  ds18b20_check();
 671          //  ds18b20_write_byte(0xcc);//SKIP ROM
 672          //     ds18b20_write_byte(0xbe);//è¯»å­˜å‚¨å™¨
 673          
 674          //  datl=ds18b20_read_byte();//ä½å­—èŠ‚
 675          //  dath=ds18b20_read_byte();//é«˜å­—èŠ‚
 676          //  value=(dath<<8)+datl;//åˆå¹¶ä¸º16ä½æ•°æ®
 677          
 678          //  if((value&0xf800)==0xf800)//åˆ¤æ–­ç¬¦å·ä½ï¼Œè´Ÿæ¸©åº¦
 679          //  {
 680          //    value=(~value)+1; //æ•°æ®å–åå†åŠ 1
 681          //    temp=value*(-0.0625);//ä¹˜ä»¥ç²¾åº¦ 
 682          //  }
 683          //  else //æ­£æ¸©åº¦
 684          //  {
 685          //    temp=value*0.0625;  
 686          //  }
 687          //  return temp;
 688          // }
 689          
 690          //ç©ºæ°”æ¹¿åº¦ä¼ æ„Ÿå™¨æ“ä½œå‡½æ•°
 691          //å¤ä½DHT11
 692          void DHT11_Rst(void)     
 693          {                 
 694   1        MOISTURE_AIR=1;
 695   1        delay_10us(1);
 696   1        MOISTURE_AIR=0;   //æ‹‰ä½DQ
 697   1          delay_ms(25);   //æ‹‰ä½è‡³å°‘18ms
 698   1          MOISTURE_AIR=1;   //DQ=1 
 699   1        delay_10us(3);  //ä¸»æœºæ‹‰é«˜20~40us
 700   1      }
 701          //ç­‰å¾…DHT11çš„å›åº”
 702          //è¿”å›1:æœªæ£€æµ‹åˆ°DHT11çš„å­˜åœ¨
 703          //è¿”å›0:å­˜åœ¨
 704          u8 DHT11_Check(void)     
 705          {   
 706   1        u8 retry=0;
 707   1        
 708   1        while (!MOISTURE_AIR&&retry<100)//åˆ¤æ–­ä»æœºå‘å‡º 80us çš„ä½ç”µå¹³å“åº”ä¿¡å·æ˜¯å¦ç»“æŸ
 709   1        {
 710   2          retry++;
 711   2          _nop_();
 712   2        };
 713   1        if(retry>=100)return 1;
 714   1        else retry=0;
 715   1          while (MOISTURE_AIR&&retry<100)//åˆ¤æ–­ä»æœºå‘å‡º 80us çš„é«˜ç”µå¹³æ˜¯å¦ç»“æŸ?ï¼¨ç¼ƒå´¾?åˆ™ä¸»æœºè
             -¿›å…¥æ•°æ®æ¥æ”¶çŠ¶æ€
 716   1        {
 717   2          retry++;
 718   2          _nop_();
 719   2        };   
 720   1        if(retry>=100)return 1;     
 721   1        return 0;
 722   1      }
 723          
 724          
 725          //DHT11åˆå§‹åŒ– /////////////////////////////////////////////////////////////////////////////////////////
             -/////////
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 13  

 726          //è¿”å›0ï¼šåˆå§‹åŒ–æˆåŠŸï¼Œ1ï¼šå¤±è´¥
 727          u8 DHT11_Init(void)
 728          {
 729   1        MOISTURE_AIR=1;
 730   1        DHT11_Rst();    
 731   1        return DHT11_Check(); 
 732   1      }
 733          
 734          //ä»DHT11è¯»å–ä¸€ä¸ªå­—èŠ‚
 735          //è¿”å›å€¼ï¼šè¯»åˆ°çš„æ•°æ®
 736          u8 DHT11_Read_Byte(void)    
 737          {        
 738   1          u8 i,temp;
 739   1        u8 data_byte=0; 
 740   1        u8 retry=0;
 741   1      
 742   1          for(i=0;i<8;i++)//æ¥æ”¶8bitçš„æ•°æ® 
 743   1          { 
 744   2      //    while(!MOISTURE_AIR);//ç­‰å¾…50usçš„ä½ç”µå¹³å¼€å§‹ä¿¡å·ç»“æŸ
 745   2          while (!MOISTURE_AIR&&retry<50)//ç­‰å¾…50usçš„ä½ç”µå¹³å¼€å§‹ä¿¡å·ç»“æŸ
 746   2          {
 747   3            retry++;
 748   3            _nop_();
 749   3          };
 750   2          retry=0; 
 751   2          delay_10us(3);//ç­‰å¾…40us 
 752   2          temp=0;//æ—¶é—´ä¸º26us-28us?ï¼‘ç¡çª˜é‚®ç›å¥ˆ?æ•°æ®'0' 
 753   2          if(MOISTURE_AIR==1) 
 754   2            temp=1; //å¦‚æœ26us-28usä¹‹å?ï¼›åˆ®?é«˜ç”µå¹³?ï¼´è™®ç¡çª˜é‚®ç›æ°–?æ®ä¸º'1' 
 755   2      //    while(MOISTURE_AIR);//ç­‰å¾…æ•°æ®ä¿¡å·é«˜ç”µå¹³??'0'ä¸º26us-28us??'1'ä¸º70us
 756   2          while (MOISTURE_AIR&&retry<100)//ç­‰å¾…æ•°æ®ä¿¡å·é«˜ç”µå¹³??'0'ä¸º26us-28us??'1'ä¸º70us
 757   2          {
 758   3            retry++;
 759   3            _nop_();
 760   3          };
 761   2          data_byte<<=1;//æ¥æ”¶çš„æ•°æ®ä¸ºé«˜ä½åœ¨å‰?âˆ®ä¹™ç¯‡? 
 762   2          data_byte|=temp; 
 763   2          } 
 764   1      
 765   1          return data_byte;
 766   1      }
 767          
 768          // //ä»DHT11è¯»å–ä¸€æ¬¡æ•°æ®///////////////////////////////////////////////////////////////////////////
             -///////////////////////
 769          // //temp:æ¸©åº¦å€¼(èŒƒå›´:0~50Â°)
 770          // //humi:æ¹¿åº¦å€¼(èŒƒå›´:20%~90%)
 771          // //è¿”å›å€¼ï¼š0,æ­£å¸¸;1,è¯»å–å¤±è´¥
 772          // u8 air_moisture_read(u8 *temp,u8 *humi)    
 773          // {        
 774          //    u8 buf[5];
 775          //  u8 i;
 776          //  DHT11_Rst();
 777          //  if(DHT11_Check()==0)
 778          //  {
 779          //    for(i=0;i<5;i++)//è¯»å–40ä½æ•°æ®
 780          //    {
 781          //      buf[i]=DHT11_Read_Byte();
 782          //    }
 783          //    if((buf[0]+buf[1]+buf[2]+buf[3])==buf[4])
 784          //    {
 785          //      *humi=buf[0];
 786          //      *temp=buf[2];
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 14  

 787          //    }
 788              
 789          //  }else return 1;
 790          //  return 0;     
 791          // }
 792          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 793          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 794          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 795          
 796          //è¯»å–æ¸©åº¦
 797          float temperature_read(void)
 798          {
 799   1        float temp;
 800   1        u8 dath=0;
 801   1        u8 datl=0;
 802   1        u16 value=0;
 803   1      
 804   1        ds18b20_start();//å¼€å§‹è½¬æ¢
 805   1        ds18b20_reset();//å¤ä½
 806   1        ds18b20_check();
 807   1        ds18b20_write_byte(0xcc);//SKIP ROM
 808   1          ds18b20_write_byte(0xbe);//è¯»å­˜å‚¨å™¨
 809   1      
 810   1        datl=ds18b20_read_byte();//ä½å­—èŠ‚
 811   1        dath=ds18b20_read_byte();//é«˜å­—èŠ‚
 812   1        value=(dath<<8)+datl;//åˆå¹¶ä¸º16ä½æ•°æ®
 813   1      
 814   1        if((value&0xf800)==0xf800)//åˆ¤æ–­ç¬¦å·ä½ï¼Œè´Ÿæ¸©åº¦
 815   1        {
 816   2          value=(~value)+1; //æ•°æ®å–åå†åŠ 1
 817   2          temp=value*(-0.0625);//ä¹˜ä»¥ç²¾åº¦ 
 818   2        }
 819   1        else //æ­£æ¸©åº¦
 820   1        {
 821   2          temp=value*0.0625;  
 822   2        }
 823   1        return temp;
 824   1      }
 825          
 826          //åœŸå£¤æ¹¿åº¦ä¼ æ„Ÿå™¨è¯»å–
 827          u8 soil_moisture_read(void)
 828          {
 829   1        u8 soil_moisture_adc;
 830   1        soil_moisture_adc=ADC_read_data(0);
 831   1        return soil_moisture_adc;
 832   1      }
 833          //æ°´ä½ä¼ æ„Ÿå™¨è¯»å–
 834          u8 water_lavel_read(void)
 835          {
 836   1        u8 water_lavel_adc;
 837   1        water_lavel_adc=ADC_read_data(1);
 838   1        return water_lavel_adc;
 839   1      }
 840          
 841          //ä»DHT11è¯»å–ä¸€æ¬¡æ•°æ®
 842          //temp:æ¸©åº¦å€¼
 843          //humi:æ¹¿åº¦å€¼
 844          void air_moisture_read(void)    
 845          {        
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 15  

 846   1        u8 buf[5];
 847   1        u8 i;
 848   1        DHT11_Rst();
 849   1        if(DHT11_Check()==0)
 850   1        {
 851   2          for(i=0;i<5;i++)//è¯»å–40ä½æ•°æ®
 852   2          {
 853   3            buf[i]=DHT11_Read_Byte();
 854   3          }
 855   2          if((buf[0]+buf[1]+buf[2]+buf[3])==buf[4])
 856   2          {
 857   3            humi=buf[0];
 858   3            temp=buf[2];
 859   3          }
 860   2          
 861   2        }   
 862   1      }
 863          
 864          //å…‰ç…§å¼ºåº¦æ¢æµ‹
 865          u8 light_intensity_read(void)
 866          {
 867   1        u8 light_value_adc;
 868   1        light_value_adc=xpt2046_read_adc_value(0xE4);
 869   1        return light_value_adc;
 870   1      }
 871          
 872          //é®å…‰æ¿æ“ä½œå‡½æ•°ï¼Œ1ä¸Šåˆ°é¡¶ç«¯ï¼Œ0ä¸‹åˆ°åº•ç«¯
 873          void step_motor_control(u16 input){
 874   1          if(input!=StepMotor_status)
 875   1          {
 876   2            u8 dir=0;//é»˜è®¤é€†æ—¶é’ˆæ–¹å‘
 877   2            u8 speed=STEPMOTOR_MAXSPEED;//é»˜è®¤æœ€å¤§é€Ÿåº¦æ—‹è½¬
 878   2            u8 step=0;
 879   2              u16 time=0;
 880   2              u16 usetime=STEPMOTOR_SHIELD_HIGHT*STEPMOTOR_SHIELD_RANGE;
 881   2      
 882   2              if(input==1)
 883   2              {
 884   3                  while(time<=usetime){
 885   4                      step_motor_28BYJ48_send_pulse(step++,dir);
 886   4                      time++;
 887   4                      if(step==8)step=0;    
 888   4                      delay_ms(speed);
 889   4                  }
 890   3            StepMotor_status=1;
 891   3              }
 892   2              if(input==0)
 893   2              {
 894   3                  dir=!dir;
 895   3                  while(time<=usetime){
 896   4                      step_motor_28BYJ48_send_pulse(step++,dir);
 897   4                      time++;
 898   4                      if(step==8)step=0;    
 899   4                      delay_ms(speed);
 900   4                  }
 901   3            StepMotor_status=0;
 902   3              }
 903   2          }
 904   1      }
 905          
 906          //æ°´æ³µæ“ä½œå‡½æ•°ï¼Œè¾“å…¥ä¾›æ°´å¤šå°‘æ¯«ç§’
 907          void pump_control(u16 input)
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 16  

 908          {
 909   1          PUMP=1;
 910   1          delay_ms(input);
 911   1          PUMP=0;
 912   1      }
 913          
 914          //é›¾åŒ–å™¨æ“ä½œå‡½æ•°ï¼Œ1å¼€å¯ï¼Œ0å…³é—­
 915          void spray_control(u16 input)
 916          {
 917   1          SPRAY=input;
 918   1      }
 919          
 920          //è¡¥å…‰ç¯æ“ä½œå‡½æ•°ï¼Œ1å¼€å¯ï¼Œ0å…³é—­
 921          void light_control(u16 input)
 922          {
 923   1          LIGHT=input;
 924   1      }
 925          
 926          
 927          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 928          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 929          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
 930          
 931          void all_data_read(void)
 932          {
 933   1        //æ¸©åº¦
 934   1        temp_value=temperature_read()*10;
 935   1      
 936   1        if(temp_value<0)
 937   1        {
 938   2          temp_value=-temp_value;
 939   2          temp_buf[0]='-';  
 940   2        }
 941   1        else
 942   1          temp_buf[0]=' ';
 943   1        if(temp_value>=1000)
 944   1          temp_buf[1]=temp_value/1000+0x30;
 945   1        else
 946   1          temp_buf[1]=' ';
 947   1        temp_buf[2]=temp_value%1000/100+0x30;
 948   1        temp_buf[3]=temp_value%1000%100/10+0x30;
 949   1        temp_buf[4]='.';
 950   1        temp_buf[5]=temp_value%1000%100%10+0x30;
 951   1        temp_buf[6]='C';
 952   1        temp_buf[7]='\0'; 
 953   1      
 954   1        //åœŸå£¤æ¹¿åº¦
 955   1        soil_moisture=soil_moisture_read();
 956   1      
 957   1        soil_moisture_buf[0]=soil_moisture%1000/100+0x30;
 958   1        soil_moisture_buf[1]=soil_moisture%1000%100/10+0x30;
 959   1        soil_moisture_buf[2]=soil_moisture%1000%100%10+0x30;
 960   1        soil_moisture_buf[3]='\0';
 961   1      
 962   1        //æ°´ä½é«˜åº¦
 963   1        water_lavel=water_lavel_read();
 964   1      
 965   1        water_lavel_buf[0]=water_lavel%1000/100+0x30;
 966   1        water_lavel_buf[1]=water_lavel%1000%100/10+0x30;
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 17  

 967   1        water_lavel_buf[2]=water_lavel%1000%100%10+0x30;
 968   1        water_lavel_buf[3]='\0';
 969   1      
 970   1        //ç©ºæ°”æ¹¿åº¦
 971   1        air_moisture_read();
 972   1        temp_buf2[0]=temp/10+0x30;  
 973   1        temp_buf2[1]=temp%10+0x30;
 974   1        temp_buf2[2]='\0';
 975   1      
 976   1        humi_buf[0]=humi/10+0x30; 
 977   1        humi_buf[1]=humi%10+0x30;
 978   1        humi_buf[2]='\0';
 979   1      
 980   1        //å…‰ç…§å¼ºåº¦
 981   1        light_intensity=light_intensity_read();
 982   1        light_intensity_buf[0]=light_intensity%1000/100+0x30;
 983   1        light_intensity_buf[1]=light_intensity%1000%100/10+0x30;
 984   1        light_intensity_buf[2]=light_intensity%1000%100%10+0x30;
 985   1        light_intensity_buf[3]='\0';
 986   1      }
 987          
 988          void all_init(void)
 989          {
 990   1        lcd1602_init();
 991   1        lcd1602_show_string(0,0,"Self-testing");
 992   1        stay_time=0;
 993   1        ds18b20_init();
 994   1        DHT11_Init();
 995   1        step_motor_control(0);
 996   1        pump_control(500);
 997   1        spray_control(0);
 998   1        light_control(0);
 999   1        allow_test2=0;
1000   1        allow_pump=0;
1001   1        lcd1602_init();
1002   1        lcd1602_show_string(0,0,"Self-test");
1003   1        lcd1602_show_string(0,1,"Success!!!");
1004   1      }
1005          
1006          
1007          
1008          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
1009          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
1010          //////////////////////////////////////////////////////////////////////////////////////////////////////////
             -/////////////////////////////////
1011          //æµ‹è¯•å‡½æ•°ç¿»å†™
1012          void test_key(void)
1013          {
1014   1        key=key_matrix_flip_scan();
1015   1        switch(key)
1016   1        {
1017   2          case(1):{
1018   3            lcd1602_init();
1019   3            lcd1602_show_string(0,0,"Temperature:");//ç¬¬ä¸€è¡Œæ˜¾ç¤º
1020   3            lcd1602_show_string(0,1,temp_buf);//ç¬¬äºŒè¡Œæ˜¾ç¤º
1021   3            break;  
1022   3          }
1023   2          case(2):{
1024   3            lcd1602_init();
1025   3            lcd1602_show_string(0,0,"Soil Moisture:");//ç¬¬ä¸€è¡Œæ˜¾ç¤º
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 18  

1026   3            lcd1602_show_string(0,1,soil_moisture_buf);//ç¬¬äºŒè¡Œæ˜¾ç¤º
1027   3            break;  
1028   3          }
1029   2          case(3):{
1030   3            lcd1602_init();
1031   3            lcd1602_show_string(0,0,"Water Level:");//ç¬¬ä¸€è¡Œæ˜¾ç¤º
1032   3            lcd1602_show_string(0,1,water_lavel_buf);//ç¬¬äºŒè¡Œæ˜¾ç¤º
1033   3            break;  
1034   3          }
1035   2          case(4):{
1036   3            lcd1602_init();
1037   3            lcd1602_show_string(0,0,"Air Moisture:");//ç¬¬ä¸€è¡Œæ˜¾ç¤º
1038   3            lcd1602_show_string(0,1,humi_buf);//ç¬¬äºŒè¡Œæ˜¾ç¤º
1039   3            break;  
1040   3          }
1041   2          case(5):{
1042   3            lcd1602_init();
1043   3            lcd1602_show_string(0,0,"Light Intensity:");//ç¬¬ä¸€è¡Œæ˜¾ç¤º
1044   3            lcd1602_show_string(0,1,light_intensity_buf);//ç¬¬äºŒè¡Œæ˜¾ç¤º
1045   3            break;  
1046   3          }
1047   2          case(6):{
1048   3            if(StepMotor_status==0){
1049   4              lcd1602_init();
1050   4              lcd1602_show_string(0,0,"Shield Rising");
1051   4              step_motor_control(1);
1052   4              lcd1602_init();
1053   4              lcd1602_show_string(0,0,"Shield Rised");
1054   4            }
1055   3            else{
1056   4              lcd1602_init();
1057   4              lcd1602_show_string(0,0,"Shield Falling");
1058   4              step_motor_control(0);
1059   4              lcd1602_init();
1060   4              lcd1602_show_string(0,0,"Shield Falled");
1061   4            }
1062   3            break;  
1063   3          }
1064   2          case(7):{
1065   3            lcd1602_init();
1066   3            lcd1602_show_string(0,0,"Pump Working");
1067   3            pump_control(3000);
1068   3            lcd1602_show_string(0,0,"Pump Worked 3s");
1069   3            break;  
1070   3          }
1071   2          case(8):{
1072   3            if(SPRAY==0){
1073   4              lcd1602_init();
1074   4              lcd1602_show_string(0,0,"Spray Work Begin");
1075   4              spray_control(1);
1076   4            }
1077   3            else{
1078   4              lcd1602_init();
1079   4              lcd1602_show_string(0,0,"Spray Work Stop");
1080   4              spray_control(0);
1081   4            }
1082   3            break;  
1083   3          }
1084   2          case(9):{
1085   3            if(LIGHT==0){
1086   4              lcd1602_init();
1087   4              lcd1602_show_string(0,0,"LED Work Begin");
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 19  

1088   4              light_control(1);
1089   4            }
1090   3            else{
1091   4              lcd1602_init();
1092   4              lcd1602_show_string(0,0,"LED Work Stop");
1093   4              light_control(0);
1094   4            }
1095   3            break;  
1096   3          }
1097   2          case(10):{
1098   3            if(allow_test2==0){
1099   4              lcd1602_init();
1100   4              lcd1602_show_string(0,0,"AUTO Work Begin");
1101   4              allow_test2=1;
1102   4            }
1103   3            else{
1104   4              lcd1602_init();
1105   4              lcd1602_show_string(0,0,"AUTO Work Stop");
1106   4              allow_test2=0;
1107   4            }
1108   3            break;  
1109   3          }
1110   2          case(11):{
1111   3            if(allow_pump==0){
1112   4              lcd1602_init();
1113   4              lcd1602_show_string(0,0,"Pump Allow");
1114   4              allow_pump=1;
1115   4            }
1116   3            else{
1117   4              lcd1602_init();
1118   4              lcd1602_show_string(0,0,"Pump NOT Allow");
1119   4              allow_pump=0;
1120   4            }
1121   3            break;  
1122   3          }
1123   2          case(12):{
1124   3            all_init();
1125   3            break;  
1126   3          }
1127   2          case(13):{
1128   3            
1129   3          }
1130   2          case(14):{
1131   3            
1132   3            break;  
1133   3          }
1134   2          case(15):{
1135   3            
1136   3            break;  
1137   3          }
1138   2          case(16):{
1139   3            break;  
1140   3          }
1141   2          default:{
1142   3            break;
1143   3          }
1144   2        }
1145   1      }
1146          
1147          
1148          
1149          void test2(void){
C51 COMPILER V9.60.7.0   MAIN                                                              12/26/2024 19:40:01 PAGE 20  

1150   1        if(temp_value > need_temp)
1151   1          step_motor_control(1);
1152   1        if(temp_value < need_temp)
1153   1          step_motor_control(0);
1154   1      
1155   1        if(light_intensity > need_light_intensity)
1156   1          light_control(1);
1157   1        if(light_intensity < need_light_intensity)
1158   1          light_control(0);
1159   1      
1160   1        if(humi < need_air_moisture)
1161   1          spray_control(1);
1162   1        if(humi > need_air_moisture)
1163   1          spray_control(0);
1164   1      
1165   1        if(water_lavel<=need_water_lavel&&allow_pump==1)
1166   1          pump_control(1000);
1167   1          all_data_read();
1168   1      
1169   1      }
1170          
1171          
1172          
1173          
1174          
1175          int main()
1176          {
1177   1        all_init();
1178   1        while(1)
1179   1        {
1180   2          stay_time++;
1181   2          if(stay_time==22000)
1182   2          {
1183   3            all_data_read();
1184   3            stay_time=0;
1185   3          }
1186   2          test_key();
1187   2          if(allow_test2)
1188   2            test2();
1189   2      
1190   2        }
1191   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2626    ----
   CONSTANT SIZE    =    309    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     57      24
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
